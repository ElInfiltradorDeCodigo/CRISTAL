"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[7523],{7523:(nh,xr,T)=>{T.d(xr,{KQ:()=>eh});var P=T(5879),kr=T(6321),Ar=T(5592),Dr=T(2096),cs=T(3019),Se=T(7398),Or=T(3020),Mr=T(4664),hs=T(6699),Lr=T(3997),us=T(9360),Jt=T(8251),Fr=T(4829),Wr=T(2737),Ur=T(2420),Br=T(4564),fe=T(8186),pt=T(6304),Hr=(T(5967),T(3106)),Ue=T(4537),Qr=T(5861),gt=T(534),c=T(9058),Zt=T(7879);const ds="@firebase/database";let en="";function _s(n){en=n}class Kr{constructor(e){this.domStorage_=e,this.prefix_="firebase:"}set(e,t){null==t?this.domStorage_.removeItem(this.prefixedName_(e)):this.domStorage_.setItem(this.prefixedName_(e),(0,c.Wl)(t))}get(e){const t=this.domStorage_.getItem(this.prefixedName_(e));return null==t?null:(0,c.cI)(t)}remove(e){this.domStorage_.removeItem(this.prefixedName_(e))}prefixedName_(e){return this.prefix_+e}toString(){return this.domStorage_.toString()}}class Yr{constructor(){this.cache_={},this.isInMemoryStorage=!0}set(e,t){null==t?delete this.cache_[e]:this.cache_[e]=t}get(e){return(0,c.r3)(this.cache_,e)?this.cache_[e]:null}remove(e){delete this.cache_[e]}}const ps=function(n){try{if(typeof window<"u"&&typeof window[n]<"u"){const e=window[n];return e.setItem("firebase:sentinel","cache"),e.removeItem("firebase:sentinel"),new Kr(e)}}catch{}return new Yr},_e=ps("localStorage"),tn=ps("sessionStorage"),be=new Zt.Yd("@firebase/database"),gs=function(){let n=1;return function(){return n++}}(),ms=function(n){const e=(0,c.dS)(n),t=new c.gQ;t.update(e);const s=t.digest();return c.US.encodeByteArray(s)},Be=function(...n){let e="";for(let t=0;t<n.length;t++){const s=n[t];Array.isArray(s)||s&&"object"==typeof s&&"number"==typeof s.length?e+=Be.apply(null,s):e+="object"==typeof s?(0,c.Wl)(s):s,e+=" "}return e};let pe=null,ys=!0;const vs=function(n,e){(0,c.hu)(!e||!0===n||!1===n,"Can't turn on custom loggers persistently."),!0===n?(be.logLevel=Zt.in.VERBOSE,pe=be.log.bind(be),e&&tn.set("logging_enabled",!0)):"function"==typeof n?pe=n:(pe=null,tn.remove("logging_enabled"))},x=function(...n){if(!0===ys&&(ys=!1,null===pe&&!0===tn.get("logging_enabled")&&vs(!0)),pe){const e=Be.apply(null,n);pe(e)}},Ve=function(n){return function(...e){x(n,...e)}},nn=function(...n){const e="FIREBASE INTERNAL ERROR: "+Be(...n);be.error(e)},j=function(...n){const e=`FIREBASE FATAL ERROR: ${Be(...n)}`;throw be.error(e),new Error(e)},O=function(...n){const e="FIREBASE WARNING: "+Be(...n);be.warn(e)},mt=function(n){return"number"==typeof n&&(n!=n||n===Number.POSITIVE_INFINITY||n===Number.NEGATIVE_INFINITY)},te="[MIN_NAME]",J="[MAX_NAME]",ge=function(n,e){if(n===e)return 0;if(n===te||e===J)return-1;if(e===te||n===J)return 1;{const t=Es(n),s=Es(e);return null!==t?null!==s?t-s==0?n.length-e.length:t-s:-1:null!==s?1:n<e?-1:1}},$r=function(n,e){return n===e?0:n<e?-1:1},Ge=function(n,e){if(e&&n in e)return e[n];throw new Error("Missing required key ("+n+") in object: "+(0,c.Wl)(e))},sn=function(n){if("object"!=typeof n||null===n)return(0,c.Wl)(n);const e=[];for(const s in n)e.push(s);e.sort();let t="{";for(let s=0;s<e.length;s++)0!==s&&(t+=","),t+=(0,c.Wl)(e[s]),t+=":",t+=sn(n[e[s]]);return t+="}",t},Cs=function(n,e){const t=n.length;if(t<=e)return[n];const s=[];for(let i=0;i<t;i+=e)s.push(n.substring(i,i+e>t?t:i+e));return s};function k(n,e){for(const t in n)n.hasOwnProperty(t)&&e(t,n[t])}const ws=function(n){(0,c.hu)(!mt(n),"Invalid JSON number");const s=1023;let i,r,o,l,a;0===n?(r=0,o=0,i=1/n==-1/0?1:0):(i=n<0,(n=Math.abs(n))>=Math.pow(2,1-s)?(l=Math.min(Math.floor(Math.log(n)/Math.LN2),s),r=l+s,o=Math.round(n*Math.pow(2,52-l)-Math.pow(2,52))):(r=0,o=Math.round(n/Math.pow(2,-1074))));const h=[];for(a=52;a;a-=1)h.push(o%2?1:0),o=Math.floor(o/2);for(a=11;a;a-=1)h.push(r%2?1:0),r=Math.floor(r/2);h.push(i?1:0),h.reverse();const u=h.join("");let d="";for(a=0;a<64;a+=8){let f=parseInt(u.substr(a,8),2).toString(16);1===f.length&&(f="0"+f),d+=f}return d.toLowerCase()},Zr=new RegExp("^-?(0*)\\d{1,10}$"),Es=function(n){if(Zr.test(n)){const e=Number(n);if(e>=-2147483648&&e<=2147483647)return e}return null},Ne=function(n){try{n()}catch(e){setTimeout(()=>{throw O("Exception was thrown by user callback.",e.stack||""),e},Math.floor(0))}},He=function(n,e){const t=setTimeout(n,e);return"number"==typeof t&&typeof Deno<"u"&&Deno.unrefTimer?Deno.unrefTimer(t):"object"==typeof t&&t.unref&&t.unref(),t};class so{constructor(e,t){this.appName_=e,this.appCheckProvider=t,this.appCheck=null==t?void 0:t.getImmediate({optional:!0}),this.appCheck||null==t||t.get().then(s=>this.appCheck=s)}getToken(e){return this.appCheck?this.appCheck.getToken(e):new Promise((t,s)=>{setTimeout(()=>{this.appCheck?this.getToken(e).then(t,s):t(null)},0)})}addTokenChangeListener(e){var t;null===(t=this.appCheckProvider)||void 0===t||t.get().then(s=>s.addTokenListener(e))}notifyForInvalidToken(){O(`Provided AppCheck credentials for the app named "${this.appName_}" are invalid. This usually indicates your app was not initialized correctly.`)}}class io{constructor(e,t,s){this.appName_=e,this.firebaseOptions_=t,this.authProvider_=s,this.auth_=null,this.auth_=s.getImmediate({optional:!0}),this.auth_||s.onInit(i=>this.auth_=i)}getToken(e){return this.auth_?this.auth_.getToken(e).catch(t=>t&&"auth/token-not-initialized"===t.code?(x("Got auth/token-not-initialized error.  Treating as null token."),null):Promise.reject(t)):new Promise((t,s)=>{setTimeout(()=>{this.auth_?this.getToken(e).then(t,s):t(null)},0)})}addTokenChangeListener(e){this.auth_?this.auth_.addAuthTokenListener(e):this.authProvider_.get().then(t=>t.addAuthTokenListener(e))}removeTokenChangeListener(e){this.authProvider_.get().then(t=>t.removeAuthTokenListener(e))}notifyForInvalidToken(){let e='Provided authentication credentials for the app named "'+this.appName_+'" are invalid. This usually indicates your app was not initialized correctly. ';e+="credential"in this.firebaseOptions_?'Make sure the "credential" property provided to initializeApp() is authorized to access the specified "databaseURL" and is from the correct project.':"serviceAccount"in this.firebaseOptions_?'Make sure the "serviceAccount" property provided to initializeApp() is authorized to access the specified "databaseURL" and is from the correct project.':'Make sure the "apiKey" and "databaseURL" properties provided to initializeApp() match the values provided for your app at https://console.firebase.google.com/.',O(e)}}let Qe=(()=>{class n{constructor(t){this.accessToken=t}getToken(t){return Promise.resolve({accessToken:this.accessToken})}addTokenChangeListener(t){t(this.accessToken)}removeTokenChangeListener(t){}notifyForInvalidToken(){}}return n.OWNER="owner",n})();const Ns=/(console\.firebase|firebase-console-\w+\.corp|firebase\.corp)\.google\.com/,xs="websocket",ks="long_polling";class on{constructor(e,t,s,i,r=!1,o="",l=!1,a=!1){this.secure=t,this.namespace=s,this.webSocketOnly=i,this.nodeAdmin=r,this.persistenceKey=o,this.includeNamespaceInQueryParams=l,this.isUsingEmulator=a,this._host=e.toLowerCase(),this._domain=this._host.substr(this._host.indexOf(".")+1),this.internalHost=_e.get("host:"+e)||this._host}isCacheableHost(){return"s-"===this.internalHost.substr(0,2)}isCustomHost(){return"firebaseio.com"!==this._domain&&"firebaseio-demo.com"!==this._domain}get host(){return this._host}set host(e){e!==this.internalHost&&(this.internalHost=e,this.isCacheableHost()&&_e.set("host:"+this._host,this.internalHost))}toString(){let e=this.toURLString();return this.persistenceKey&&(e+="<"+this.persistenceKey+">"),e}toURLString(){return`${this.secure?"https://":"http://"}${this.host}/${this.includeNamespaceInQueryParams?`?ns=${this.namespace}`:""}`}}function As(n,e,t){let s;if((0,c.hu)("string"==typeof e,"typeof type must == string"),(0,c.hu)("object"==typeof t,"typeof params must == object"),e===xs)s=(n.secure?"wss://":"ws://")+n.internalHost+"/.ws?";else{if(e!==ks)throw new Error("Unknown connection type: "+e);s=(n.secure?"https://":"http://")+n.internalHost+"/.lp?"}(function ro(n){return n.host!==n.internalHost||n.isCustomHost()||n.includeNamespaceInQueryParams})(n)&&(t.ns=n.namespace);const i=[];return k(t,(r,o)=>{i.push(r+"="+o)}),s+i.join("&")}class oo{constructor(){this.counters_={}}incrementCounter(e,t=1){(0,c.r3)(this.counters_,e)||(this.counters_[e]=0),this.counters_[e]+=t}get(){return(0,c.p$)(this.counters_)}}const ln={},an={};function cn(n){const e=n.toString();return ln[e]||(ln[e]=new oo),ln[e]}class ao{constructor(e){this.onMessage_=e,this.pendingResponses=[],this.currentResponseNum=0,this.closeAfterResponse=-1,this.onClose=null}closeAfter(e,t){this.closeAfterResponse=e,this.onClose=t,this.closeAfterResponse<this.currentResponseNum&&(this.onClose(),this.onClose=null)}handleResponse(e,t){for(this.pendingResponses[e]=t;this.pendingResponses[this.currentResponseNum];){const s=this.pendingResponses[this.currentResponseNum];delete this.pendingResponses[this.currentResponseNum];for(let i=0;i<s.length;++i)s[i]&&Ne(()=>{this.onMessage_(s[i])});if(this.currentResponseNum===this.closeAfterResponse){this.onClose&&(this.onClose(),this.onClose=null);break}this.currentResponseNum++}}}class ne{constructor(e,t,s,i,r,o,l){this.connId=e,this.repoInfo=t,this.applicationId=s,this.appCheckToken=i,this.authToken=r,this.transportSessionId=o,this.lastSessionId=l,this.bytesSent=0,this.bytesReceived=0,this.everConnected_=!1,this.log_=Ve(e),this.stats_=cn(t),this.urlFn=a=>(this.appCheckToken&&(a.ac=this.appCheckToken),As(t,ks,a))}open(e,t){this.curSegmentNum=0,this.onDisconnect_=t,this.myPacketOrderer=new ao(e),this.isClosed_=!1,this.connectTimeoutTimer_=setTimeout(()=>{this.log_("Timed out trying to connect."),this.onClosed_(),this.connectTimeoutTimer_=null},Math.floor(3e4)),function(n){if((0,c.Yr)()||"complete"===document.readyState)n();else{let e=!1;const t=function(){document.body?e||(e=!0,n()):setTimeout(t,Math.floor(10))};document.addEventListener?(document.addEventListener("DOMContentLoaded",t,!1),window.addEventListener("load",t,!1)):document.attachEvent&&(document.attachEvent("onreadystatechange",()=>{"complete"===document.readyState&&t()}),window.attachEvent("onload",t))}}(()=>{if(this.isClosed_)return;this.scriptTagHolder=new hn((...r)=>{const[o,l,a,h,u]=r;if(this.incrementIncomingBytes_(r),this.scriptTagHolder)if(this.connectTimeoutTimer_&&(clearTimeout(this.connectTimeoutTimer_),this.connectTimeoutTimer_=null),this.everConnected_=!0,"start"===o)this.id=l,this.password=a;else{if("close"!==o)throw new Error("Unrecognized command received: "+o);l?(this.scriptTagHolder.sendNewPolls=!1,this.myPacketOrderer.closeAfter(l,()=>{this.onClosed_()})):this.onClosed_()}},(...r)=>{const[o,l]=r;this.incrementIncomingBytes_(r),this.myPacketOrderer.handleResponse(o,l)},()=>{this.onClosed_()},this.urlFn);const s={start:"t"};s.ser=Math.floor(1e8*Math.random()),this.scriptTagHolder.uniqueCallbackIdentifier&&(s.cb=this.scriptTagHolder.uniqueCallbackIdentifier),s.v="5",this.transportSessionId&&(s.s=this.transportSessionId),this.lastSessionId&&(s.ls=this.lastSessionId),this.applicationId&&(s.p=this.applicationId),this.appCheckToken&&(s.ac=this.appCheckToken),typeof location<"u"&&location.hostname&&Ns.test(location.hostname)&&(s.r="f");const i=this.urlFn(s);this.log_("Connecting via long-poll to "+i),this.scriptTagHolder.addTag(i,()=>{})})}start(){this.scriptTagHolder.startLongPoll(this.id,this.password),this.addDisconnectPingFrame(this.id,this.password)}static forceAllow(){ne.forceAllow_=!0}static forceDisallow(){ne.forceDisallow_=!0}static isAvailable(){return!((0,c.Yr)()||!ne.forceAllow_&&(ne.forceDisallow_||!(typeof document<"u")||null==document.createElement||"object"==typeof window&&window.chrome&&window.chrome.extension&&!/^chrome/.test(window.location.href)||"object"==typeof Windows&&"object"==typeof Windows.UI))}markConnectionHealthy(){}shutdown_(){this.isClosed_=!0,this.scriptTagHolder&&(this.scriptTagHolder.close(),this.scriptTagHolder=null),this.myDisconnFrame&&(document.body.removeChild(this.myDisconnFrame),this.myDisconnFrame=null),this.connectTimeoutTimer_&&(clearTimeout(this.connectTimeoutTimer_),this.connectTimeoutTimer_=null)}onClosed_(){this.isClosed_||(this.log_("Longpoll is closing itself"),this.shutdown_(),this.onDisconnect_&&(this.onDisconnect_(this.everConnected_),this.onDisconnect_=null))}close(){this.isClosed_||(this.log_("Longpoll is being closed."),this.shutdown_())}send(e){const t=(0,c.Wl)(e);this.bytesSent+=t.length,this.stats_.incrementCounter("bytes_sent",t.length);const s=(0,c.h$)(t),i=Cs(s,1840);for(let r=0;r<i.length;r++)this.scriptTagHolder.enqueueSegment(this.curSegmentNum,i.length,i[r]),this.curSegmentNum++}addDisconnectPingFrame(e,t){if((0,c.Yr)())return;this.myDisconnFrame=document.createElement("iframe");const s={dframe:"t"};s.id=e,s.pw=t,this.myDisconnFrame.src=this.urlFn(s),this.myDisconnFrame.style.display="none",document.body.appendChild(this.myDisconnFrame)}incrementIncomingBytes_(e){const t=(0,c.Wl)(e).length;this.bytesReceived+=t,this.stats_.incrementCounter("bytes_received",t)}}class hn{constructor(e,t,s,i){if(this.onDisconnect=s,this.urlFn=i,this.outstandingRequests=new Set,this.pendingSegs=[],this.currentSerial=Math.floor(1e8*Math.random()),this.sendNewPolls=!0,(0,c.Yr)())this.commandCB=e,this.onMessageCB=t;else{this.uniqueCallbackIdentifier=gs(),window["pLPCommand"+this.uniqueCallbackIdentifier]=e,window["pRTLPCB"+this.uniqueCallbackIdentifier]=t,this.myIFrame=hn.createIFrame_();let r="";this.myIFrame.src&&"javascript:"===this.myIFrame.src.substr(0,11)&&(r='<script>document.domain="'+document.domain+'";<\/script>');const o="<html><body>"+r+"</body></html>";try{this.myIFrame.doc.open(),this.myIFrame.doc.write(o),this.myIFrame.doc.close()}catch(l){x("frame writing exception"),l.stack&&x(l.stack),x(l)}}}static createIFrame_(){const e=document.createElement("iframe");if(e.style.display="none",!document.body)throw"Document body has not initialized. Wait to initialize Firebase until after the document is ready.";document.body.appendChild(e);try{e.contentWindow.document||x("No IE domain setting required")}catch{const s=document.domain;e.src="javascript:void((function(){document.open();document.domain='"+s+"';document.close();})())"}return e.contentDocument?e.doc=e.contentDocument:e.contentWindow?e.doc=e.contentWindow.document:e.document&&(e.doc=e.document),e}close(){this.alive=!1,this.myIFrame&&(this.myIFrame.doc.body.textContent="",setTimeout(()=>{null!==this.myIFrame&&(document.body.removeChild(this.myIFrame),this.myIFrame=null)},Math.floor(0)));const e=this.onDisconnect;e&&(this.onDisconnect=null,e())}startLongPoll(e,t){for(this.myID=e,this.myPW=t,this.alive=!0;this.newRequest_(););}newRequest_(){if(this.alive&&this.sendNewPolls&&this.outstandingRequests.size<(this.pendingSegs.length>0?2:1)){this.currentSerial++;const e={};e.id=this.myID,e.pw=this.myPW,e.ser=this.currentSerial;let t=this.urlFn(e),s="",i=0;for(;this.pendingSegs.length>0&&this.pendingSegs[0].d.length+30+s.length<=1870;){const o=this.pendingSegs.shift();s=s+"&seg"+i+"="+o.seg+"&ts"+i+"="+o.ts+"&d"+i+"="+o.d,i++}return t+=s,this.addLongPollTag_(t,this.currentSerial),!0}return!1}enqueueSegment(e,t,s){this.pendingSegs.push({seg:e,ts:t,d:s}),this.alive&&this.newRequest_()}addLongPollTag_(e,t){this.outstandingRequests.add(t);const s=()=>{this.outstandingRequests.delete(t),this.newRequest_()},i=setTimeout(s,Math.floor(25e3));this.addTag(e,()=>{clearTimeout(i),s()})}addTag(e,t){(0,c.Yr)()?this.doNodeLongPoll(e,t):setTimeout(()=>{try{if(!this.sendNewPolls)return;const s=this.myIFrame.doc.createElement("script");s.type="text/javascript",s.async=!0,s.src=e,s.onload=s.onreadystatechange=function(){const i=s.readyState;(!i||"loaded"===i||"complete"===i)&&(s.onload=s.onreadystatechange=null,s.parentNode&&s.parentNode.removeChild(s),t())},s.onerror=()=>{x("Long-poll script failed to load: "+e),this.sendNewPolls=!1,this.close()},this.myIFrame.doc.body.appendChild(s)}catch{}},Math.floor(1))}}let vt=null;typeof MozWebSocket<"u"?vt=MozWebSocket:typeof WebSocket<"u"&&(vt=WebSocket);let Re=(()=>{class n{constructor(t,s,i,r,o,l,a){this.connId=t,this.applicationId=i,this.appCheckToken=r,this.authToken=o,this.keepaliveTimer=null,this.frames=null,this.totalFrames=0,this.bytesSent=0,this.bytesReceived=0,this.log_=Ve(this.connId),this.stats_=cn(s),this.connURL=n.connectionURL_(s,l,a,r,i),this.nodeAdmin=s.nodeAdmin}static connectionURL_(t,s,i,r,o){const l={v:"5"};return!(0,c.Yr)()&&typeof location<"u"&&location.hostname&&Ns.test(location.hostname)&&(l.r="f"),s&&(l.s=s),i&&(l.ls=i),r&&(l.ac=r),o&&(l.p=o),As(t,xs,l)}open(t,s){this.onDisconnect=s,this.onMessage=t,this.log_("Websocket connecting to "+this.connURL),this.everConnected_=!1,_e.set("previous_websocket_failure",!0);try{let i;if((0,c.Yr)()){i={headers:{"User-Agent":`Firebase/5/${en}/${process.platform}/${this.nodeAdmin?"AdminNode":"Node"}`,"X-Firebase-GMPID":this.applicationId||""}},this.authToken&&(i.headers.Authorization=`Bearer ${this.authToken}`),this.appCheckToken&&(i.headers["X-Firebase-AppCheck"]=this.appCheckToken);const o=process.env,l=0===this.connURL.indexOf("wss://")?o.HTTPS_PROXY||o.https_proxy:o.HTTP_PROXY||o.http_proxy;l&&(i.proxy={origin:l})}this.mySock=new vt(this.connURL,[],i)}catch(i){this.log_("Error instantiating WebSocket.");const r=i.message||i.data;return r&&this.log_(r),void this.onClosed_()}this.mySock.onopen=()=>{this.log_("Websocket connected."),this.everConnected_=!0},this.mySock.onclose=()=>{this.log_("Websocket connection was disconnected."),this.mySock=null,this.onClosed_()},this.mySock.onmessage=i=>{this.handleIncomingFrame(i)},this.mySock.onerror=i=>{this.log_("WebSocket error.  Closing connection.");const r=i.message||i.data;r&&this.log_(r),this.onClosed_()}}start(){}static forceDisallow(){n.forceDisallow_=!0}static isAvailable(){let t=!1;if(typeof navigator<"u"&&navigator.userAgent){const i=navigator.userAgent.match(/Android ([0-9]{0,}\.[0-9]{0,})/);i&&i.length>1&&parseFloat(i[1])<4.4&&(t=!0)}return!t&&null!==vt&&!n.forceDisallow_}static previouslyFailed(){return _e.isInMemoryStorage||!0===_e.get("previous_websocket_failure")}markConnectionHealthy(){_e.remove("previous_websocket_failure")}appendFrame_(t){if(this.frames.push(t),this.frames.length===this.totalFrames){const s=this.frames.join("");this.frames=null;const i=(0,c.cI)(s);this.onMessage(i)}}handleNewFrameCount_(t){this.totalFrames=t,this.frames=[]}extractFrameCount_(t){if((0,c.hu)(null===this.frames,"We already have a frame buffer"),t.length<=6){const s=Number(t);if(!isNaN(s))return this.handleNewFrameCount_(s),null}return this.handleNewFrameCount_(1),t}handleIncomingFrame(t){if(null===this.mySock)return;const s=t.data;if(this.bytesReceived+=s.length,this.stats_.incrementCounter("bytes_received",s.length),this.resetKeepAlive(),null!==this.frames)this.appendFrame_(s);else{const i=this.extractFrameCount_(s);null!==i&&this.appendFrame_(i)}}send(t){this.resetKeepAlive();const s=(0,c.Wl)(t);this.bytesSent+=s.length,this.stats_.incrementCounter("bytes_sent",s.length);const i=Cs(s,16384);i.length>1&&this.sendString_(String(i.length));for(let r=0;r<i.length;r++)this.sendString_(i[r])}shutdown_(){this.isClosed_=!0,this.keepaliveTimer&&(clearInterval(this.keepaliveTimer),this.keepaliveTimer=null),this.mySock&&(this.mySock.close(),this.mySock=null)}onClosed_(){this.isClosed_||(this.log_("WebSocket is closing itself"),this.shutdown_(),this.onDisconnect&&(this.onDisconnect(this.everConnected_),this.onDisconnect=null))}close(){this.isClosed_||(this.log_("WebSocket is being closed"),this.shutdown_())}resetKeepAlive(){clearInterval(this.keepaliveTimer),this.keepaliveTimer=setInterval(()=>{this.mySock&&this.sendString_("0"),this.resetKeepAlive()},Math.floor(45e3))}sendString_(t){try{this.mySock.send(t)}catch(s){this.log_("Exception thrown from WebSocket.send():",s.message||s.data,"Closing connection."),setTimeout(this.onClosed_.bind(this),0)}}}return n.responsesRequiredToBeHealthy=2,n.healthyTimeout=3e4,n})(),Us=(()=>{class n{constructor(t){this.initTransports_(t)}static get ALL_TRANSPORTS(){return[ne,Re]}static get IS_TRANSPORT_INITIALIZED(){return this.globalTransportInitialized_}initTransports_(t){const s=Re&&Re.isAvailable();let i=s&&!Re.previouslyFailed();if(t.webSocketOnly&&(s||O("wss:// URL used, but browser isn't known to support websockets.  Trying anyway."),i=!0),i)this.transports_=[Re];else{const r=this.transports_=[];for(const o of n.ALL_TRANSPORTS)o&&o.isAvailable()&&r.push(o);n.globalTransportInitialized_=!0}}initialTransport(){if(this.transports_.length>0)return this.transports_[0];throw new Error("No transports available")}upgradeTransport(){return this.transports_.length>1?this.transports_[1]:null}}return n.globalTransportInitialized_=!1,n})();class Ys{constructor(e,t,s,i,r,o,l,a,h,u){this.id=e,this.repoInfo_=t,this.applicationId_=s,this.appCheckToken_=i,this.authToken_=r,this.onMessage_=o,this.onReady_=l,this.onDisconnect_=a,this.onKill_=h,this.lastSessionId=u,this.connectionCount=0,this.pendingDataMessages=[],this.state_=0,this.log_=Ve("c:"+this.id+":"),this.transportManager_=new Us(t),this.log_("Connection created"),this.start_()}start_(){const e=this.transportManager_.initialTransport();this.conn_=new e(this.nextTransportId_(),this.repoInfo_,this.applicationId_,this.appCheckToken_,this.authToken_,null,this.lastSessionId),this.primaryResponsesRequired_=e.responsesRequiredToBeHealthy||0;const t=this.connReceiver_(this.conn_),s=this.disconnReceiver_(this.conn_);this.tx_=this.conn_,this.rx_=this.conn_,this.secondaryConn_=null,this.isHealthy_=!1,setTimeout(()=>{this.conn_&&this.conn_.open(t,s)},Math.floor(0));const i=e.healthyTimeout||0;i>0&&(this.healthyTimeout_=He(()=>{this.healthyTimeout_=null,this.isHealthy_||(this.conn_&&this.conn_.bytesReceived>102400?(this.log_("Connection exceeded healthy timeout but has received "+this.conn_.bytesReceived+" bytes.  Marking connection healthy."),this.isHealthy_=!0,this.conn_.markConnectionHealthy()):this.conn_&&this.conn_.bytesSent>10240?this.log_("Connection exceeded healthy timeout but has sent "+this.conn_.bytesSent+" bytes.  Leaving connection alive."):(this.log_("Closing unhealthy connection after timeout."),this.close()))},Math.floor(i)))}nextTransportId_(){return"c:"+this.id+":"+this.connectionCount++}disconnReceiver_(e){return t=>{e===this.conn_?this.onConnectionLost_(t):e===this.secondaryConn_?(this.log_("Secondary connection lost."),this.onSecondaryConnectionLost_()):this.log_("closing an old connection")}}connReceiver_(e){return t=>{2!==this.state_&&(e===this.rx_?this.onPrimaryMessageReceived_(t):e===this.secondaryConn_?this.onSecondaryMessageReceived_(t):this.log_("message on old connection"))}}sendRequest(e){this.sendData_({t:"d",d:e})}tryCleanupConnection(){this.tx_===this.secondaryConn_&&this.rx_===this.secondaryConn_&&(this.log_("cleaning up and promoting a connection: "+this.secondaryConn_.connId),this.conn_=this.secondaryConn_,this.secondaryConn_=null)}onSecondaryControl_(e){if("t"in e){const t=e.t;"a"===t?this.upgradeIfSecondaryHealthy_():"r"===t?(this.log_("Got a reset on secondary, closing it"),this.secondaryConn_.close(),(this.tx_===this.secondaryConn_||this.rx_===this.secondaryConn_)&&this.close()):"o"===t&&(this.log_("got pong on secondary."),this.secondaryResponsesRequired_--,this.upgradeIfSecondaryHealthy_())}}onSecondaryMessageReceived_(e){const t=Ge("t",e),s=Ge("d",e);if("c"===t)this.onSecondaryControl_(s);else{if("d"!==t)throw new Error("Unknown protocol layer: "+t);this.pendingDataMessages.push(s)}}upgradeIfSecondaryHealthy_(){this.secondaryResponsesRequired_<=0?(this.log_("Secondary connection is healthy."),this.isHealthy_=!0,this.secondaryConn_.markConnectionHealthy(),this.proceedWithUpgrade_()):(this.log_("sending ping on secondary."),this.secondaryConn_.send({t:"c",d:{t:"p",d:{}}}))}proceedWithUpgrade_(){this.secondaryConn_.start(),this.log_("sending client ack on secondary"),this.secondaryConn_.send({t:"c",d:{t:"a",d:{}}}),this.log_("Ending transmission on primary"),this.conn_.send({t:"c",d:{t:"n",d:{}}}),this.tx_=this.secondaryConn_,this.tryCleanupConnection()}onPrimaryMessageReceived_(e){const t=Ge("t",e),s=Ge("d",e);"c"===t?this.onControl_(s):"d"===t&&this.onDataMessage_(s)}onDataMessage_(e){this.onPrimaryResponse_(),this.onMessage_(e)}onPrimaryResponse_(){this.isHealthy_||(this.primaryResponsesRequired_--,this.primaryResponsesRequired_<=0&&(this.log_("Primary connection is healthy."),this.isHealthy_=!0,this.conn_.markConnectionHealthy()))}onControl_(e){const t=Ge("t",e);if("d"in e){const s=e.d;if("h"===t){const i=Object.assign({},s);this.repoInfo_.isUsingEmulator&&(i.h=this.repoInfo_.host),this.onHandshake_(i)}else if("n"===t){this.log_("recvd end transmission on primary"),this.rx_=this.secondaryConn_;for(let i=0;i<this.pendingDataMessages.length;++i)this.onDataMessage_(this.pendingDataMessages[i]);this.pendingDataMessages=[],this.tryCleanupConnection()}else"s"===t?this.onConnectionShutdown_(s):"r"===t?this.onReset_(s):"e"===t?nn("Server Error: "+s):"o"===t?(this.log_("got pong on primary."),this.onPrimaryResponse_(),this.sendPingOnPrimaryIfNecessary_()):nn("Unknown control packet command: "+t)}}onHandshake_(e){const t=e.ts,s=e.v,i=e.h;this.sessionId=e.s,this.repoInfo_.host=i,0===this.state_&&(this.conn_.start(),this.onConnectionEstablished_(this.conn_,t),"5"!==s&&O("Protocol version mismatch detected"),this.tryStartUpgrade_())}tryStartUpgrade_(){const e=this.transportManager_.upgradeTransport();e&&this.startUpgrade_(e)}startUpgrade_(e){this.secondaryConn_=new e(this.nextTransportId_(),this.repoInfo_,this.applicationId_,this.appCheckToken_,this.authToken_,this.sessionId),this.secondaryResponsesRequired_=e.responsesRequiredToBeHealthy||0;const t=this.connReceiver_(this.secondaryConn_),s=this.disconnReceiver_(this.secondaryConn_);this.secondaryConn_.open(t,s),He(()=>{this.secondaryConn_&&(this.log_("Timed out trying to upgrade."),this.secondaryConn_.close())},Math.floor(6e4))}onReset_(e){this.log_("Reset packet received.  New host: "+e),this.repoInfo_.host=e,1===this.state_?this.close():(this.closeConnections_(),this.start_())}onConnectionEstablished_(e,t){this.log_("Realtime connection established."),this.conn_=e,this.state_=1,this.onReady_&&(this.onReady_(t,this.sessionId),this.onReady_=null),0===this.primaryResponsesRequired_?(this.log_("Primary connection is healthy."),this.isHealthy_=!0):He(()=>{this.sendPingOnPrimaryIfNecessary_()},Math.floor(5e3))}sendPingOnPrimaryIfNecessary_(){!this.isHealthy_&&1===this.state_&&(this.log_("sending ping on primary."),this.sendData_({t:"c",d:{t:"p",d:{}}}))}onSecondaryConnectionLost_(){const e=this.secondaryConn_;this.secondaryConn_=null,(this.tx_===e||this.rx_===e)&&this.close()}onConnectionLost_(e){this.conn_=null,e||0!==this.state_?1===this.state_&&this.log_("Realtime connection lost."):(this.log_("Realtime connection failed."),this.repoInfo_.isCacheableHost()&&(_e.remove("host:"+this.repoInfo_.host),this.repoInfo_.internalHost=this.repoInfo_.host)),this.close()}onConnectionShutdown_(e){this.log_("Connection shutdown command received. Shutting down..."),this.onKill_&&(this.onKill_(e),this.onKill_=null),this.onDisconnect_=null,this.close()}sendData_(e){if(1!==this.state_)throw"Connection is not connected";this.tx_.send(e)}close(){2!==this.state_&&(this.log_("Closing realtime connection."),this.state_=2,this.closeConnections_(),this.onDisconnect_&&(this.onDisconnect_(),this.onDisconnect_=null))}closeConnections_(){this.log_("Shutting down all connections"),this.conn_&&(this.conn_.close(),this.conn_=null),this.secondaryConn_&&(this.secondaryConn_.close(),this.secondaryConn_=null),this.healthyTimeout_&&(clearTimeout(this.healthyTimeout_),this.healthyTimeout_=null)}}class js{put(e,t,s,i){}merge(e,t,s,i){}refreshAuthToken(e){}refreshAppCheckToken(e){}onDisconnectPut(e,t,s){}onDisconnectMerge(e,t,s){}onDisconnectCancel(e,t){}reportStats(e){}}class zs{constructor(e){this.allowedEvents_=e,this.listeners_={},(0,c.hu)(Array.isArray(e)&&e.length>0,"Requires a non-empty array")}trigger(e,...t){if(Array.isArray(this.listeners_[e])){const s=[...this.listeners_[e]];for(let i=0;i<s.length;i++)s[i].callback.apply(s[i].context,t)}}on(e,t,s){this.validateEventType_(e),this.listeners_[e]=this.listeners_[e]||[],this.listeners_[e].push({callback:t,context:s});const i=this.getInitialEvent(e);i&&t.apply(s,i)}off(e,t,s){this.validateEventType_(e);const i=this.listeners_[e]||[];for(let r=0;r<i.length;r++)if(i[r].callback===t&&(!s||s===i[r].context))return void i.splice(r,1)}validateEventType_(e){(0,c.hu)(this.allowedEvents_.find(t=>t===e),"Unknown event: "+e)}}class Ct extends zs{constructor(){super(["online"]),this.online_=!0,typeof window<"u"&&typeof window.addEventListener<"u"&&!(0,c.uI)()&&(window.addEventListener("online",()=>{this.online_||(this.online_=!0,this.trigger("online",!0))},!1),window.addEventListener("offline",()=>{this.online_&&(this.online_=!1,this.trigger("online",!1))},!1))}static getInstance(){return new Ct}getInitialEvent(e){return(0,c.hu)("online"===e,"Unknown event type: "+e),[this.online_]}currentlyOnline(){return this.online_}}class E{constructor(e,t){if(void 0===t){this.pieces_=e.split("/");let s=0;for(let i=0;i<this.pieces_.length;i++)this.pieces_[i].length>0&&(this.pieces_[s]=this.pieces_[i],s++);this.pieces_.length=s,this.pieceNum_=0}else this.pieces_=e,this.pieceNum_=t}toString(){let e="";for(let t=this.pieceNum_;t<this.pieces_.length;t++)""!==this.pieces_[t]&&(e+="/"+this.pieces_[t]);return e||"/"}}function w(){return new E("")}function m(n){return n.pieceNum_>=n.pieces_.length?null:n.pieces_[n.pieceNum_]}function se(n){return n.pieces_.length-n.pieceNum_}function I(n){let e=n.pieceNum_;return e<n.pieces_.length&&e++,new E(n.pieces_,e)}function dn(n){return n.pieceNum_<n.pieces_.length?n.pieces_[n.pieces_.length-1]:null}function Ke(n,e=0){return n.pieces_.slice(n.pieceNum_+e)}function Xs(n){if(n.pieceNum_>=n.pieces_.length)return null;const e=[];for(let t=n.pieceNum_;t<n.pieces_.length-1;t++)e.push(n.pieces_[t]);return new E(e,0)}function N(n,e){const t=[];for(let s=n.pieceNum_;s<n.pieces_.length;s++)t.push(n.pieces_[s]);if(e instanceof E)for(let s=e.pieceNum_;s<e.pieces_.length;s++)t.push(e.pieces_[s]);else{const s=e.split("/");for(let i=0;i<s.length;i++)s[i].length>0&&t.push(s[i])}return new E(t,0)}function y(n){return n.pieceNum_>=n.pieces_.length}function M(n,e){const t=m(n),s=m(e);if(null===t)return e;if(t===s)return M(I(n),I(e));throw new Error("INTERNAL ERROR: innerPath ("+e+") is not within outerPath ("+n+")")}function ko(n,e){const t=Ke(n,0),s=Ke(e,0);for(let i=0;i<t.length&&i<s.length;i++){const r=ge(t[i],s[i]);if(0!==r)return r}return t.length===s.length?0:t.length<s.length?-1:1}function fn(n,e){if(se(n)!==se(e))return!1;for(let t=n.pieceNum_,s=e.pieceNum_;t<=n.pieces_.length;t++,s++)if(n.pieces_[t]!==e.pieces_[s])return!1;return!0}function B(n,e){let t=n.pieceNum_,s=e.pieceNum_;if(se(n)>se(e))return!1;for(;t<n.pieces_.length;){if(n.pieces_[t]!==e.pieces_[s])return!1;++t,++s}return!0}class Ao{constructor(e,t){this.errorPrefix_=t,this.parts_=Ke(e,0),this.byteLength_=Math.max(1,this.parts_.length);for(let s=0;s<this.parts_.length;s++)this.byteLength_+=(0,c.ug)(this.parts_[s]);Js(this)}}function Js(n){if(n.byteLength_>768)throw new Error(n.errorPrefix_+"has a key path longer than 768 bytes ("+n.byteLength_+").");if(n.parts_.length>32)throw new Error(n.errorPrefix_+"path specified exceeds the maximum depth that can be written (32) or object contains a cycle "+me(n))}function me(n){return 0===n.parts_.length?"":"in property '"+n.parts_.join(".")+"'"}class _n extends zs{constructor(){let e,t;super(["visible"]),typeof document<"u"&&typeof document.addEventListener<"u"&&(typeof document.hidden<"u"?(t="visibilitychange",e="hidden"):typeof document.mozHidden<"u"?(t="mozvisibilitychange",e="mozHidden"):typeof document.msHidden<"u"?(t="msvisibilitychange",e="msHidden"):typeof document.webkitHidden<"u"&&(t="webkitvisibilitychange",e="webkitHidden")),this.visible_=!0,t&&document.addEventListener(t,()=>{const s=!document[e];s!==this.visible_&&(this.visible_=s,this.trigger("visible",s))},!1)}static getInstance(){return new _n}getInitialEvent(e){return(0,c.hu)("visible"===e,"Unknown event type: "+e),[this.visible_]}}const Ye=1e3;let Et,ye=(()=>{class n extends js{constructor(t,s,i,r,o,l,a,h){if(super(),this.repoInfo_=t,this.applicationId_=s,this.onDataUpdate_=i,this.onConnectStatus_=r,this.onServerInfoUpdate_=o,this.authTokenProvider_=l,this.appCheckTokenProvider_=a,this.authOverride_=h,this.id=n.nextPersistentConnectionId_++,this.log_=Ve("p:"+this.id+":"),this.interruptReasons_={},this.listens=new Map,this.outstandingPuts_=[],this.outstandingGets_=[],this.outstandingPutCount_=0,this.outstandingGetCount_=0,this.onDisconnectRequestQueue_=[],this.connected_=!1,this.reconnectDelay_=Ye,this.maxReconnectDelay_=3e5,this.securityDebugCallback_=null,this.lastSessionId=null,this.establishConnectionTimer_=null,this.visible_=!1,this.requestCBHash_={},this.requestNumber_=0,this.realtime_=null,this.authToken_=null,this.appCheckToken_=null,this.forceTokenRefresh_=!1,this.invalidAuthTokenCount_=0,this.invalidAppCheckTokenCount_=0,this.firstConnection_=!0,this.lastConnectionAttemptTime_=null,this.lastConnectionEstablishedTime_=null,h&&!(0,c.Yr)())throw new Error("Auth override specified in options, but not supported on non Node.js platforms");_n.getInstance().on("visible",this.onVisible_,this),-1===t.host.indexOf("fblocal")&&Ct.getInstance().on("online",this.onOnline_,this)}sendRequest(t,s,i){const r=++this.requestNumber_,o={r,a:t,b:s};this.log_((0,c.Wl)(o)),(0,c.hu)(this.connected_,"sendRequest call when we're not connected not allowed."),this.realtime_.sendRequest(o),i&&(this.requestCBHash_[r]=i)}get(t){this.initConnection_();const s=new c.BH,r={action:"g",request:{p:t._path.toString(),q:t._queryObject},onComplete:l=>{const a=l.d;"ok"===l.s?s.resolve(a):s.reject(a)}};return this.outstandingGets_.push(r),this.outstandingGetCount_++,this.connected_&&this.sendGet_(this.outstandingGets_.length-1),s.promise}listen(t,s,i,r){this.initConnection_();const o=t._queryIdentifier,l=t._path.toString();this.log_("Listen called for "+l+" "+o),this.listens.has(l)||this.listens.set(l,new Map),(0,c.hu)(t._queryParams.isDefault()||!t._queryParams.loadsAllData(),"listen() called for non-default but complete query"),(0,c.hu)(!this.listens.get(l).has(o),"listen() called twice for same path/queryId.");const a={onComplete:r,hashFn:s,query:t,tag:i};this.listens.get(l).set(o,a),this.connected_&&this.sendListen_(a)}sendGet_(t){const s=this.outstandingGets_[t];this.sendRequest("g",s.request,i=>{delete this.outstandingGets_[t],this.outstandingGetCount_--,0===this.outstandingGetCount_&&(this.outstandingGets_=[]),s.onComplete&&s.onComplete(i)})}sendListen_(t){const s=t.query,i=s._path.toString(),r=s._queryIdentifier;this.log_("Listen on "+i+" for "+r);const o={p:i};t.tag&&(o.q=s._queryObject,o.t=t.tag),o.h=t.hashFn(),this.sendRequest("q",o,a=>{const h=a.d,u=a.s;n.warnOnListenWarnings_(h,s),(this.listens.get(i)&&this.listens.get(i).get(r))===t&&(this.log_("listen response",a),"ok"!==u&&this.removeListen_(i,r),t.onComplete&&t.onComplete(u,h))})}static warnOnListenWarnings_(t,s){if(t&&"object"==typeof t&&(0,c.r3)(t,"w")){const i=(0,c.DV)(t,"w");if(Array.isArray(i)&&~i.indexOf("no_index")){const r='".indexOn": "'+s._queryParams.getIndex().toString()+'"',o=s._path.toString();O(`Using an unspecified index. Your data will be downloaded and filtered on the client. Consider adding ${r} at ${o} to your security rules for better performance.`)}}}refreshAuthToken(t){this.authToken_=t,this.log_("Auth token refreshed"),this.authToken_?this.tryAuth():this.connected_&&this.sendRequest("unauth",{},()=>{}),this.reduceReconnectDelayIfAdminCredential_(t)}reduceReconnectDelayIfAdminCredential_(t){(t&&40===t.length||(0,c.GJ)(t))&&(this.log_("Admin auth credential detected.  Reducing max reconnect time."),this.maxReconnectDelay_=3e4)}refreshAppCheckToken(t){this.appCheckToken_=t,this.log_("App check token refreshed"),this.appCheckToken_?this.tryAppCheck():this.connected_&&this.sendRequest("unappeck",{},()=>{})}tryAuth(){if(this.connected_&&this.authToken_){const t=this.authToken_,s=(0,c.w9)(t)?"auth":"gauth",i={cred:t};null===this.authOverride_?i.noauth=!0:"object"==typeof this.authOverride_&&(i.authvar=this.authOverride_),this.sendRequest(s,i,r=>{const o=r.s,l=r.d||"error";this.authToken_===t&&("ok"===o?this.invalidAuthTokenCount_=0:this.onAuthRevoked_(o,l))})}}tryAppCheck(){this.connected_&&this.appCheckToken_&&this.sendRequest("appcheck",{token:this.appCheckToken_},t=>{const s=t.s,i=t.d||"error";"ok"===s?this.invalidAppCheckTokenCount_=0:this.onAppCheckRevoked_(s,i)})}unlisten(t,s){const i=t._path.toString(),r=t._queryIdentifier;this.log_("Unlisten called for "+i+" "+r),(0,c.hu)(t._queryParams.isDefault()||!t._queryParams.loadsAllData(),"unlisten() called for non-default but complete query"),this.removeListen_(i,r)&&this.connected_&&this.sendUnlisten_(i,r,t._queryObject,s)}sendUnlisten_(t,s,i,r){this.log_("Unlisten on "+t+" for "+s);const o={p:t};r&&(o.q=i,o.t=r),this.sendRequest("n",o)}onDisconnectPut(t,s,i){this.initConnection_(),this.connected_?this.sendOnDisconnect_("o",t,s,i):this.onDisconnectRequestQueue_.push({pathString:t,action:"o",data:s,onComplete:i})}onDisconnectMerge(t,s,i){this.initConnection_(),this.connected_?this.sendOnDisconnect_("om",t,s,i):this.onDisconnectRequestQueue_.push({pathString:t,action:"om",data:s,onComplete:i})}onDisconnectCancel(t,s){this.initConnection_(),this.connected_?this.sendOnDisconnect_("oc",t,null,s):this.onDisconnectRequestQueue_.push({pathString:t,action:"oc",data:null,onComplete:s})}sendOnDisconnect_(t,s,i,r){const o={p:s,d:i};this.log_("onDisconnect "+t,o),this.sendRequest(t,o,l=>{r&&setTimeout(()=>{r(l.s,l.d)},Math.floor(0))})}put(t,s,i,r){this.putInternal("p",t,s,i,r)}merge(t,s,i,r){this.putInternal("m",t,s,i,r)}putInternal(t,s,i,r,o){this.initConnection_();const l={p:s,d:i};void 0!==o&&(l.h=o),this.outstandingPuts_.push({action:t,request:l,onComplete:r}),this.outstandingPutCount_++,this.connected_?this.sendPut_(this.outstandingPuts_.length-1):this.log_("Buffering put: "+s)}sendPut_(t){const s=this.outstandingPuts_[t].action,i=this.outstandingPuts_[t].request,r=this.outstandingPuts_[t].onComplete;this.outstandingPuts_[t].queued=this.connected_,this.sendRequest(s,i,o=>{this.log_(s+" response",o),delete this.outstandingPuts_[t],this.outstandingPutCount_--,0===this.outstandingPutCount_&&(this.outstandingPuts_=[]),r&&r(o.s,o.d)})}reportStats(t){if(this.connected_){const s={c:t};this.log_("reportStats",s),this.sendRequest("s",s,i=>{"ok"!==i.s&&this.log_("reportStats","Error sending stats: "+i.d)})}}onDataMessage_(t){if("r"in t){this.log_("from server: "+(0,c.Wl)(t));const s=t.r,i=this.requestCBHash_[s];i&&(delete this.requestCBHash_[s],i(t.b))}else{if("error"in t)throw"A server-side error has occurred: "+t.error;"a"in t&&this.onDataPush_(t.a,t.b)}}onDataPush_(t,s){this.log_("handleServerMessage",t,s),"d"===t?this.onDataUpdate_(s.p,s.d,!1,s.t):"m"===t?this.onDataUpdate_(s.p,s.d,!0,s.t):"c"===t?this.onListenRevoked_(s.p,s.q):"ac"===t?this.onAuthRevoked_(s.s,s.d):"apc"===t?this.onAppCheckRevoked_(s.s,s.d):"sd"===t?this.onSecurityDebugPacket_(s):nn("Unrecognized action received from server: "+(0,c.Wl)(t)+"\nAre you using the latest client?")}onReady_(t,s){this.log_("connection ready"),this.connected_=!0,this.lastConnectionEstablishedTime_=(new Date).getTime(),this.handleTimestamp_(t),this.lastSessionId=s,this.firstConnection_&&this.sendConnectStats_(),this.restoreState_(),this.firstConnection_=!1,this.onConnectStatus_(!0)}scheduleConnect_(t){(0,c.hu)(!this.realtime_,"Scheduling a connect when we're already connected/ing?"),this.establishConnectionTimer_&&clearTimeout(this.establishConnectionTimer_),this.establishConnectionTimer_=setTimeout(()=>{this.establishConnectionTimer_=null,this.establishConnection_()},Math.floor(t))}initConnection_(){!this.realtime_&&this.firstConnection_&&this.scheduleConnect_(0)}onVisible_(t){t&&!this.visible_&&this.reconnectDelay_===this.maxReconnectDelay_&&(this.log_("Window became visible.  Reducing delay."),this.reconnectDelay_=Ye,this.realtime_||this.scheduleConnect_(0)),this.visible_=t}onOnline_(t){t?(this.log_("Browser went online."),this.reconnectDelay_=Ye,this.realtime_||this.scheduleConnect_(0)):(this.log_("Browser went offline.  Killing connection."),this.realtime_&&this.realtime_.close())}onRealtimeDisconnect_(){if(this.log_("data client disconnected"),this.connected_=!1,this.realtime_=null,this.cancelSentTransactions_(),this.requestCBHash_={},this.shouldReconnect_()){this.visible_?this.lastConnectionEstablishedTime_&&((new Date).getTime()-this.lastConnectionEstablishedTime_>3e4&&(this.reconnectDelay_=Ye),this.lastConnectionEstablishedTime_=null):(this.log_("Window isn't visible.  Delaying reconnect."),this.reconnectDelay_=this.maxReconnectDelay_,this.lastConnectionAttemptTime_=(new Date).getTime());const t=(new Date).getTime()-this.lastConnectionAttemptTime_;let s=Math.max(0,this.reconnectDelay_-t);s=Math.random()*s,this.log_("Trying to reconnect in "+s+"ms"),this.scheduleConnect_(s),this.reconnectDelay_=Math.min(this.maxReconnectDelay_,1.3*this.reconnectDelay_)}this.onConnectStatus_(!1)}establishConnection_(){var t=this;return(0,Qr.Z)(function*(){if(t.shouldReconnect_()){t.log_("Making a connection attempt"),t.lastConnectionAttemptTime_=(new Date).getTime(),t.lastConnectionEstablishedTime_=null;const s=t.onDataMessage_.bind(t),i=t.onReady_.bind(t),r=t.onRealtimeDisconnect_.bind(t),o=t.id+":"+n.nextConnectionId_++,l=t.lastSessionId;let a=!1,h=null;const u=function(){h?h.close():(a=!0,r())};t.realtime_={close:u,sendRequest:function(_){(0,c.hu)(h,"sendRequest call when we're not connected not allowed."),h.sendRequest(_)}};const f=t.forceTokenRefresh_;t.forceTokenRefresh_=!1;try{const[_,p]=yield Promise.all([t.authTokenProvider_.getToken(f),t.appCheckTokenProvider_.getToken(f)]);a?x("getToken() completed but was canceled"):(x("getToken() completed. Creating connection."),t.authToken_=_&&_.accessToken,t.appCheckToken_=p&&p.token,h=new Ys(o,t.repoInfo_,t.applicationId_,t.appCheckToken_,t.authToken_,s,i,r,C=>{O(C+" ("+t.repoInfo_.toString()+")"),t.interrupt("server_kill")},l))}catch(_){t.log_("Failed to get token: "+_),a||(t.repoInfo_.nodeAdmin&&O(_),u())}}})()}interrupt(t){x("Interrupting connection for reason: "+t),this.interruptReasons_[t]=!0,this.realtime_?this.realtime_.close():(this.establishConnectionTimer_&&(clearTimeout(this.establishConnectionTimer_),this.establishConnectionTimer_=null),this.connected_&&this.onRealtimeDisconnect_())}resume(t){x("Resuming connection for reason: "+t),delete this.interruptReasons_[t],(0,c.xb)(this.interruptReasons_)&&(this.reconnectDelay_=Ye,this.realtime_||this.scheduleConnect_(0))}handleTimestamp_(t){const s=t-(new Date).getTime();this.onServerInfoUpdate_({serverTimeOffset:s})}cancelSentTransactions_(){for(let t=0;t<this.outstandingPuts_.length;t++){const s=this.outstandingPuts_[t];s&&"h"in s.request&&s.queued&&(s.onComplete&&s.onComplete("disconnect"),delete this.outstandingPuts_[t],this.outstandingPutCount_--)}0===this.outstandingPutCount_&&(this.outstandingPuts_=[])}onListenRevoked_(t,s){let i;i=s?s.map(o=>sn(o)).join("$"):"default";const r=this.removeListen_(t,i);r&&r.onComplete&&r.onComplete("permission_denied")}removeListen_(t,s){const i=new E(t).toString();let r;if(this.listens.has(i)){const o=this.listens.get(i);r=o.get(s),o.delete(s),0===o.size&&this.listens.delete(i)}else r=void 0;return r}onAuthRevoked_(t,s){x("Auth token revoked: "+t+"/"+s),this.authToken_=null,this.forceTokenRefresh_=!0,this.realtime_.close(),("invalid_token"===t||"permission_denied"===t)&&(this.invalidAuthTokenCount_++,this.invalidAuthTokenCount_>=3&&(this.reconnectDelay_=3e4,this.authTokenProvider_.notifyForInvalidToken()))}onAppCheckRevoked_(t,s){x("App check token revoked: "+t+"/"+s),this.appCheckToken_=null,this.forceTokenRefresh_=!0,("invalid_token"===t||"permission_denied"===t)&&(this.invalidAppCheckTokenCount_++,this.invalidAppCheckTokenCount_>=3&&this.appCheckTokenProvider_.notifyForInvalidToken())}onSecurityDebugPacket_(t){this.securityDebugCallback_?this.securityDebugCallback_(t):"msg"in t&&console.log("FIREBASE: "+t.msg.replace("\n","\nFIREBASE: "))}restoreState_(){this.tryAuth(),this.tryAppCheck();for(const t of this.listens.values())for(const s of t.values())this.sendListen_(s);for(let t=0;t<this.outstandingPuts_.length;t++)this.outstandingPuts_[t]&&this.sendPut_(t);for(;this.onDisconnectRequestQueue_.length;){const t=this.onDisconnectRequestQueue_.shift();this.sendOnDisconnect_(t.action,t.pathString,t.data,t.onComplete)}for(let t=0;t<this.outstandingGets_.length;t++)this.outstandingGets_[t]&&this.sendGet_(t)}sendConnectStats_(){const t={};let s="js";(0,c.Yr)()&&(s=this.repoInfo_.nodeAdmin?"admin_node":"node"),t["sdk."+s+"."+en.replace(/\./g,"-")]=1,(0,c.uI)()?t["framework.cordova"]=1:(0,c.b$)()&&(t["framework.reactnative"]=1),this.reportStats(t)}shouldReconnect_(){const t=Ct.getInstance().currentlyOnline();return(0,c.xb)(this.interruptReasons_)&&t}}return n.nextPersistentConnectionId_=0,n.nextConnectionId_=0,n})();class v{constructor(e,t){this.name=e,this.node=t}static Wrap(e,t){return new v(e,t)}}class wt{getCompare(){return this.compare.bind(this)}indexedValueChanged(e,t){const s=new v(te,e),i=new v(te,t);return 0!==this.compare(s,i)}minPost(){return v.MIN}}class ti extends wt{static get __EMPTY_NODE(){return Et}static set __EMPTY_NODE(e){Et=e}compare(e,t){return ge(e.name,t.name)}isDefinedOn(e){throw(0,c.g5)("KeyIndex.isDefinedOn not expected to be called.")}indexedValueChanged(e,t){return!1}minPost(){return v.MIN}maxPost(){return new v(J,Et)}makePost(e,t){return(0,c.hu)("string"==typeof e,"KeyIndex indexValue must always be a string."),new v(e,Et)}toString(){return".key"}}const z=new ti;class Tt{constructor(e,t,s,i,r=null){this.isReverse_=i,this.resultGenerator_=r,this.nodeStack_=[];let o=1;for(;!e.isEmpty();)if(o=t?s(e.key,t):1,i&&(o*=-1),o<0)e=this.isReverse_?e.left:e.right;else{if(0===o){this.nodeStack_.push(e);break}this.nodeStack_.push(e),e=this.isReverse_?e.right:e.left}}getNext(){if(0===this.nodeStack_.length)return null;let t,e=this.nodeStack_.pop();if(t=this.resultGenerator_?this.resultGenerator_(e.key,e.value):{key:e.key,value:e.value},this.isReverse_)for(e=e.left;!e.isEmpty();)this.nodeStack_.push(e),e=e.right;else for(e=e.right;!e.isEmpty();)this.nodeStack_.push(e),e=e.left;return t}hasNext(){return this.nodeStack_.length>0}peek(){if(0===this.nodeStack_.length)return null;const e=this.nodeStack_[this.nodeStack_.length-1];return this.resultGenerator_?this.resultGenerator_(e.key,e.value):{key:e.key,value:e.value}}}let gn,H=(()=>{class n{constructor(t,s,i,r,o){this.key=t,this.value=s,this.color=null!=i?i:n.RED,this.left=null!=r?r:L.EMPTY_NODE,this.right=null!=o?o:L.EMPTY_NODE}copy(t,s,i,r,o){return new n(null!=t?t:this.key,null!=s?s:this.value,null!=i?i:this.color,null!=r?r:this.left,null!=o?o:this.right)}count(){return this.left.count()+1+this.right.count()}isEmpty(){return!1}inorderTraversal(t){return this.left.inorderTraversal(t)||!!t(this.key,this.value)||this.right.inorderTraversal(t)}reverseTraversal(t){return this.right.reverseTraversal(t)||t(this.key,this.value)||this.left.reverseTraversal(t)}min_(){return this.left.isEmpty()?this:this.left.min_()}minKey(){return this.min_().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(t,s,i){let r=this;const o=i(t,r.key);return r=o<0?r.copy(null,null,null,r.left.insert(t,s,i),null):0===o?r.copy(null,s,null,null,null):r.copy(null,null,null,null,r.right.insert(t,s,i)),r.fixUp_()}removeMin_(){if(this.left.isEmpty())return L.EMPTY_NODE;let t=this;return!t.left.isRed_()&&!t.left.left.isRed_()&&(t=t.moveRedLeft_()),t=t.copy(null,null,null,t.left.removeMin_(),null),t.fixUp_()}remove(t,s){let i,r;if(i=this,s(t,i.key)<0)!i.left.isEmpty()&&!i.left.isRed_()&&!i.left.left.isRed_()&&(i=i.moveRedLeft_()),i=i.copy(null,null,null,i.left.remove(t,s),null);else{if(i.left.isRed_()&&(i=i.rotateRight_()),!i.right.isEmpty()&&!i.right.isRed_()&&!i.right.left.isRed_()&&(i=i.moveRedRight_()),0===s(t,i.key)){if(i.right.isEmpty())return L.EMPTY_NODE;r=i.right.min_(),i=i.copy(r.key,r.value,null,null,i.right.removeMin_())}i=i.copy(null,null,null,null,i.right.remove(t,s))}return i.fixUp_()}isRed_(){return this.color}fixUp_(){let t=this;return t.right.isRed_()&&!t.left.isRed_()&&(t=t.rotateLeft_()),t.left.isRed_()&&t.left.left.isRed_()&&(t=t.rotateRight_()),t.left.isRed_()&&t.right.isRed_()&&(t=t.colorFlip_()),t}moveRedLeft_(){let t=this.colorFlip_();return t.right.left.isRed_()&&(t=t.copy(null,null,null,null,t.right.rotateRight_()),t=t.rotateLeft_(),t=t.colorFlip_()),t}moveRedRight_(){let t=this.colorFlip_();return t.left.left.isRed_()&&(t=t.rotateRight_(),t=t.colorFlip_()),t}rotateLeft_(){const t=this.copy(null,null,n.RED,null,this.right.left);return this.right.copy(null,null,this.color,t,null)}rotateRight_(){const t=this.copy(null,null,n.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,t)}colorFlip_(){const t=this.left.copy(null,null,!this.left.color,null,null),s=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,t,s)}checkMaxDepth_(){const t=this.check_();return Math.pow(2,t)<=this.count()+1}check_(){if(this.isRed_()&&this.left.isRed_())throw new Error("Red node has red child("+this.key+","+this.value+")");if(this.right.isRed_())throw new Error("Right child of ("+this.key+","+this.value+") is red");const t=this.left.check_();if(t!==this.right.check_())throw new Error("Black depths differ");return t+(this.isRed_()?0:1)}}return n.RED=!0,n.BLACK=!1,n})();class L{constructor(e,t=L.EMPTY_NODE){this.comparator_=e,this.root_=t}insert(e,t){return new L(this.comparator_,this.root_.insert(e,t,this.comparator_).copy(null,null,H.BLACK,null,null))}remove(e){return new L(this.comparator_,this.root_.remove(e,this.comparator_).copy(null,null,H.BLACK,null,null))}get(e){let t,s=this.root_;for(;!s.isEmpty();){if(t=this.comparator_(e,s.key),0===t)return s.value;t<0?s=s.left:t>0&&(s=s.right)}return null}getPredecessorKey(e){let t,s=this.root_,i=null;for(;!s.isEmpty();){if(t=this.comparator_(e,s.key),0===t){if(s.left.isEmpty())return i?i.key:null;for(s=s.left;!s.right.isEmpty();)s=s.right;return s.key}t<0?s=s.left:t>0&&(i=s,s=s.right)}throw new Error("Attempted to find predecessor key for a nonexistent key.  What gives?")}isEmpty(){return this.root_.isEmpty()}count(){return this.root_.count()}minKey(){return this.root_.minKey()}maxKey(){return this.root_.maxKey()}inorderTraversal(e){return this.root_.inorderTraversal(e)}reverseTraversal(e){return this.root_.reverseTraversal(e)}getIterator(e){return new Tt(this.root_,null,this.comparator_,!1,e)}getIteratorFrom(e,t){return new Tt(this.root_,e,this.comparator_,!1,t)}getReverseIteratorFrom(e,t){return new Tt(this.root_,e,this.comparator_,!0,t)}getReverseIterator(e){return new Tt(this.root_,null,this.comparator_,!0,e)}}function Bo(n,e){return ge(n.name,e.name)}function pn(n,e){return ge(n,e)}L.EMPTY_NODE=new class Uo{copy(e,t,s,i,r){return this}insert(e,t,s){return new H(e,t,null)}remove(e,t){return this}count(){return 0}isEmpty(){return!0}inorderTraversal(e){return!1}reverseTraversal(e){return!1}minKey(){return null}maxKey(){return null}check_(){return 0}isRed_(){return!1}};const ni=function(n){return"number"==typeof n?"number:"+ws(n):"string:"+n},si=function(n){if(n.isLeafNode()){const e=n.val();(0,c.hu)("string"==typeof e||"number"==typeof e||"object"==typeof e&&(0,c.r3)(e,".sv"),"Priority must be a string or number.")}else(0,c.hu)(n===gn||n.isEmpty(),"priority of unexpected type.");(0,c.hu)(n===gn||n.getPriority().isEmpty(),"Priority nodes can't have a priority of their own.")};let ii,ri,oi,Pe=(()=>{class n{constructor(t,s=n.__childrenNodeConstructor.EMPTY_NODE){this.value_=t,this.priorityNode_=s,this.lazyHash_=null,(0,c.hu)(null!=this.value_,"LeafNode shouldn't be created with null/undefined value."),si(this.priorityNode_)}static set __childrenNodeConstructor(t){ii=t}static get __childrenNodeConstructor(){return ii}isLeafNode(){return!0}getPriority(){return this.priorityNode_}updatePriority(t){return new n(this.value_,t)}getImmediateChild(t){return".priority"===t?this.priorityNode_:n.__childrenNodeConstructor.EMPTY_NODE}getChild(t){return y(t)?this:".priority"===m(t)?this.priorityNode_:n.__childrenNodeConstructor.EMPTY_NODE}hasChild(){return!1}getPredecessorChildName(t,s){return null}updateImmediateChild(t,s){return".priority"===t?this.updatePriority(s):s.isEmpty()&&".priority"!==t?this:n.__childrenNodeConstructor.EMPTY_NODE.updateImmediateChild(t,s).updatePriority(this.priorityNode_)}updateChild(t,s){const i=m(t);return null===i?s:s.isEmpty()&&".priority"!==i?this:((0,c.hu)(".priority"!==i||1===se(t),".priority must be the last token in a path"),this.updateImmediateChild(i,n.__childrenNodeConstructor.EMPTY_NODE.updateChild(I(t),s)))}isEmpty(){return!1}numChildren(){return 0}forEachChild(t,s){return!1}val(t){return t&&!this.getPriority().isEmpty()?{".value":this.getValue(),".priority":this.getPriority().val()}:this.getValue()}hash(){if(null===this.lazyHash_){let t="";this.priorityNode_.isEmpty()||(t+="priority:"+ni(this.priorityNode_.val())+":");const s=typeof this.value_;t+=s+":",t+="number"===s?ws(this.value_):this.value_,this.lazyHash_=ms(t)}return this.lazyHash_}getValue(){return this.value_}compareTo(t){return t===n.__childrenNodeConstructor.EMPTY_NODE?1:t instanceof n.__childrenNodeConstructor?-1:((0,c.hu)(t.isLeafNode(),"Unknown node type"),this.compareToLeafNode_(t))}compareToLeafNode_(t){const s=typeof t.value_,i=typeof this.value_,r=n.VALUE_TYPE_ORDER.indexOf(s),o=n.VALUE_TYPE_ORDER.indexOf(i);return(0,c.hu)(r>=0,"Unknown leaf type: "+s),(0,c.hu)(o>=0,"Unknown leaf type: "+i),r===o?"object"===i?0:this.value_<t.value_?-1:this.value_===t.value_?0:1:o-r}withIndex(){return this}isIndexed(){return!0}equals(t){return t===this||!!t.isLeafNode()&&(this.value_===t.value_&&this.priorityNode_.equals(t.priorityNode_))}}return n.VALUE_TYPE_ORDER=["object","boolean","number","string"],n})();const S=new class Qo extends wt{compare(e,t){const s=e.node.getPriority(),i=t.node.getPriority(),r=s.compareTo(i);return 0===r?ge(e.name,t.name):r}isDefinedOn(e){return!e.getPriority().isEmpty()}indexedValueChanged(e,t){return!e.getPriority().equals(t.getPriority())}minPost(){return v.MIN}maxPost(){return new v(J,new Pe("[PRIORITY-POST]",oi))}makePost(e,t){const s=ri(e);return new v(t,new Pe("[PRIORITY-POST]",s))}toString(){return".priority"}},Ko=Math.log(2);class Yo{constructor(e){this.count=parseInt(Math.log(e+1)/Ko,10),this.current_=this.count-1;const i=(r=>parseInt(Array(this.count+1).join("1"),2))();this.bits_=e+1&i}nextBitIsOne(){const e=!(this.bits_&1<<this.current_);return this.current_--,e}}const It=function(n,e,t,s){n.sort(e);const i=function(a,h){const u=h-a;let d,f;if(0===u)return null;if(1===u)return d=n[a],f=t?t(d):d,new H(f,d.node,H.BLACK,null,null);{const _=parseInt(u/2,10)+a,p=i(a,_),C=i(_+1,h);return d=n[_],f=t?t(d):d,new H(f,d.node,H.BLACK,p,C)}},l=function(a){let h=null,u=null,d=n.length;const f=function(p,C){const A=d-p,X=d;d-=p;const ee=i(A+1,X),We=n[A],th=t?t(We):We;_(new H(th,We.node,C,null,ee))},_=function(p){h?(h.left=p,h=p):(u=p,h=p)};for(let p=0;p<a.count;++p){const C=a.nextBitIsOne(),A=Math.pow(2,a.count-(p+1));C?f(A,H.BLACK):(f(A,H.BLACK),f(A,H.RED))}return u}(new Yo(n.length));return new L(s||e,l)};let mn;const xe={};class Z{constructor(e,t){this.indexes_=e,this.indexSet_=t}static get Default(){return(0,c.hu)(xe&&S,"ChildrenNode.ts has not been loaded"),mn=mn||new Z({".priority":xe},{".priority":S}),mn}get(e){const t=(0,c.DV)(this.indexes_,e);if(!t)throw new Error("No index defined for "+e);return t instanceof L?t:null}hasIndex(e){return(0,c.r3)(this.indexSet_,e.toString())}addIndex(e,t){(0,c.hu)(e!==z,"KeyIndex always exists and isn't meant to be added to the IndexMap.");const s=[];let i=!1;const r=t.getIterator(v.Wrap);let l,o=r.getNext();for(;o;)i=i||e.isDefinedOn(o.node),s.push(o),o=r.getNext();l=i?It(s,e.getCompare()):xe;const a=e.toString(),h=Object.assign({},this.indexSet_);h[a]=e;const u=Object.assign({},this.indexes_);return u[a]=l,new Z(u,h)}addToIndexes(e,t){const s=(0,c.UI)(this.indexes_,(i,r)=>{const o=(0,c.DV)(this.indexSet_,r);if((0,c.hu)(o,"Missing index implementation for "+r),i===xe){if(o.isDefinedOn(e.node)){const l=[],a=t.getIterator(v.Wrap);let h=a.getNext();for(;h;)h.name!==e.name&&l.push(h),h=a.getNext();return l.push(e),It(l,o.getCompare())}return xe}{const l=t.get(e.name);let a=i;return l&&(a=a.remove(new v(e.name,l))),a.insert(e,e.node)}});return new Z(s,this.indexSet_)}removeFromIndexes(e,t){const s=(0,c.UI)(this.indexes_,i=>{if(i===xe)return i;{const r=t.get(e.name);return r?i.remove(new v(e.name,r)):i}});return new Z(s,this.indexSet_)}}let je,g=(()=>{class n{constructor(t,s,i){this.children_=t,this.priorityNode_=s,this.indexMap_=i,this.lazyHash_=null,this.priorityNode_&&si(this.priorityNode_),this.children_.isEmpty()&&(0,c.hu)(!this.priorityNode_||this.priorityNode_.isEmpty(),"An empty node cannot have a priority")}static get EMPTY_NODE(){return je||(je=new n(new L(pn),null,Z.Default))}isLeafNode(){return!1}getPriority(){return this.priorityNode_||je}updatePriority(t){return this.children_.isEmpty()?this:new n(this.children_,t,this.indexMap_)}getImmediateChild(t){if(".priority"===t)return this.getPriority();{const s=this.children_.get(t);return null===s?je:s}}getChild(t){const s=m(t);return null===s?this:this.getImmediateChild(s).getChild(I(t))}hasChild(t){return null!==this.children_.get(t)}updateImmediateChild(t,s){if((0,c.hu)(s,"We should always be passing snapshot nodes"),".priority"===t)return this.updatePriority(s);{const i=new v(t,s);let r,o;s.isEmpty()?(r=this.children_.remove(t),o=this.indexMap_.removeFromIndexes(i,this.children_)):(r=this.children_.insert(t,s),o=this.indexMap_.addToIndexes(i,this.children_));const l=r.isEmpty()?je:this.priorityNode_;return new n(r,l,o)}}updateChild(t,s){const i=m(t);if(null===i)return s;{(0,c.hu)(".priority"!==m(t)||1===se(t),".priority must be the last token in a path");const r=this.getImmediateChild(i).updateChild(I(t),s);return this.updateImmediateChild(i,r)}}isEmpty(){return this.children_.isEmpty()}numChildren(){return this.children_.count()}val(t){if(this.isEmpty())return null;const s={};let i=0,r=0,o=!0;if(this.forEachChild(S,(l,a)=>{s[l]=a.val(t),i++,o&&n.INTEGER_REGEXP_.test(l)?r=Math.max(r,Number(l)):o=!1}),!t&&o&&r<2*i){const l=[];for(const a in s)l[a]=s[a];return l}return t&&!this.getPriority().isEmpty()&&(s[".priority"]=this.getPriority().val()),s}hash(){if(null===this.lazyHash_){let t="";this.getPriority().isEmpty()||(t+="priority:"+ni(this.getPriority().val())+":"),this.forEachChild(S,(s,i)=>{const r=i.hash();""!==r&&(t+=":"+s+":"+r)}),this.lazyHash_=""===t?"":ms(t)}return this.lazyHash_}getPredecessorChildName(t,s,i){const r=this.resolveIndex_(i);if(r){const o=r.getPredecessorKey(new v(t,s));return o?o.name:null}return this.children_.getPredecessorKey(t)}getFirstChildName(t){const s=this.resolveIndex_(t);if(s){const i=s.minKey();return i&&i.name}return this.children_.minKey()}getFirstChild(t){const s=this.getFirstChildName(t);return s?new v(s,this.children_.get(s)):null}getLastChildName(t){const s=this.resolveIndex_(t);if(s){const i=s.maxKey();return i&&i.name}return this.children_.maxKey()}getLastChild(t){const s=this.getLastChildName(t);return s?new v(s,this.children_.get(s)):null}forEachChild(t,s){const i=this.resolveIndex_(t);return i?i.inorderTraversal(r=>s(r.name,r.node)):this.children_.inorderTraversal(s)}getIterator(t){return this.getIteratorFrom(t.minPost(),t)}getIteratorFrom(t,s){const i=this.resolveIndex_(s);if(i)return i.getIteratorFrom(t,r=>r);{const r=this.children_.getIteratorFrom(t.name,v.Wrap);let o=r.peek();for(;null!=o&&s.compare(o,t)<0;)r.getNext(),o=r.peek();return r}}getReverseIterator(t){return this.getReverseIteratorFrom(t.maxPost(),t)}getReverseIteratorFrom(t,s){const i=this.resolveIndex_(s);if(i)return i.getReverseIteratorFrom(t,r=>r);{const r=this.children_.getReverseIteratorFrom(t.name,v.Wrap);let o=r.peek();for(;null!=o&&s.compare(o,t)>0;)r.getNext(),o=r.peek();return r}}compareTo(t){return this.isEmpty()?t.isEmpty()?0:-1:t.isLeafNode()||t.isEmpty()?1:t===ze?-1:0}withIndex(t){if(t===z||this.indexMap_.hasIndex(t))return this;{const s=this.indexMap_.addIndex(t,this.children_);return new n(this.children_,this.priorityNode_,s)}}isIndexed(t){return t===z||this.indexMap_.hasIndex(t)}equals(t){if(t===this)return!0;if(t.isLeafNode())return!1;{const s=t;if(this.getPriority().equals(s.getPriority())){if(this.children_.count()===s.children_.count()){const i=this.getIterator(S),r=s.getIterator(S);let o=i.getNext(),l=r.getNext();for(;o&&l;){if(o.name!==l.name||!o.node.equals(l.node))return!1;o=i.getNext(),l=r.getNext()}return null===o&&null===l}return!1}return!1}}resolveIndex_(t){return t===z?null:this.indexMap_.get(t.toString())}}return n.INTEGER_REGEXP_=/^(0|[1-9]\d*)$/,n})();const ze=new class jo extends g{constructor(){super(new L(pn),g.EMPTY_NODE,Z.Default)}compareTo(e){return e===this?0:1}equals(e){return e===this}getPriority(){return this}getImmediateChild(e){return g.EMPTY_NODE}isEmpty(){return!1}};Object.defineProperties(v,{MIN:{value:new v(te,g.EMPTY_NODE)},MAX:{value:new v(J,ze)}}),ti.__EMPTY_NODE=g.EMPTY_NODE,Pe.__childrenNodeConstructor=g,function Vo(n){gn=n}(ze),function Ho(n){oi=n}(ze);const zo=!0;function R(n,e=null){if(null===n)return g.EMPTY_NODE;if("object"==typeof n&&".priority"in n&&(e=n[".priority"]),(0,c.hu)(null===e||"string"==typeof e||"number"==typeof e||"object"==typeof e&&".sv"in e,"Invalid priority type found: "+typeof e),"object"==typeof n&&".value"in n&&null!==n[".value"]&&(n=n[".value"]),"object"!=typeof n||".sv"in n)return new Pe(n,R(e));if(n instanceof Array||!zo){let t=g.EMPTY_NODE;return k(n,(s,i)=>{if((0,c.r3)(n,s)&&"."!==s.substring(0,1)){const r=R(i);(r.isLeafNode()||!r.isEmpty())&&(t=t.updateImmediateChild(s,r))}}),t.updatePriority(R(e))}{const t=[];let s=!1;if(k(n,(o,l)=>{if("."!==o.substring(0,1)){const a=R(l);a.isEmpty()||(s=s||!a.getPriority().isEmpty(),t.push(new v(o,a)))}}),0===t.length)return g.EMPTY_NODE;const r=It(t,Bo,o=>o.name,pn);if(s){const o=It(t,S.getCompare());return new g(r,R(e),new Z({".priority":o},{".priority":S}))}return new g(r,R(e),Z.Default)}}!function Go(n){ri=n}(R);class yn extends wt{constructor(e){super(),this.indexPath_=e,(0,c.hu)(!y(e)&&".priority"!==m(e),"Can't create PathIndex with empty path or .priority key")}extractChild(e){return e.getChild(this.indexPath_)}isDefinedOn(e){return!e.getChild(this.indexPath_).isEmpty()}compare(e,t){const s=this.extractChild(e.node),i=this.extractChild(t.node),r=s.compareTo(i);return 0===r?ge(e.name,t.name):r}makePost(e,t){const s=R(e),i=g.EMPTY_NODE.updateChild(this.indexPath_,s);return new v(t,i)}maxPost(){const e=g.EMPTY_NODE.updateChild(this.indexPath_,ze);return new v(J,e)}toString(){return Ke(this.indexPath_,0).join("/")}}const vn=new class $o extends wt{compare(e,t){const s=e.node.compareTo(t.node);return 0===s?ge(e.name,t.name):s}isDefinedOn(e){return!0}indexedValueChanged(e,t){return!e.equals(t)}minPost(){return v.MIN}maxPost(){return v.MAX}makePost(e,t){const s=R(e);return new v(t,s)}toString(){return".value"}};function li(n){return{type:"value",snapshotNode:n}}function ke(n,e){return{type:"child_added",snapshotNode:e,childName:n}}function $e(n,e){return{type:"child_removed",snapshotNode:e,childName:n}}function qe(n,e,t){return{type:"child_changed",snapshotNode:e,childName:n,oldSnap:t}}class Cn{constructor(e){this.index_=e}updateChild(e,t,s,i,r,o){(0,c.hu)(e.isIndexed(this.index_),"A node must be indexed if only a child is updated");const l=e.getImmediateChild(t);return l.getChild(i).equals(s.getChild(i))&&l.isEmpty()===s.isEmpty()||(null!=o&&(s.isEmpty()?e.hasChild(t)?o.trackChildChange($e(t,l)):(0,c.hu)(e.isLeafNode(),"A child remove without an old child only makes sense on a leaf node"):l.isEmpty()?o.trackChildChange(ke(t,s)):o.trackChildChange(qe(t,s,l))),e.isLeafNode()&&s.isEmpty())?e:e.updateImmediateChild(t,s).withIndex(this.index_)}updateFullNode(e,t,s){return null!=s&&(e.isLeafNode()||e.forEachChild(S,(i,r)=>{t.hasChild(i)||s.trackChildChange($e(i,r))}),t.isLeafNode()||t.forEachChild(S,(i,r)=>{if(e.hasChild(i)){const o=e.getImmediateChild(i);o.equals(r)||s.trackChildChange(qe(i,r,o))}else s.trackChildChange(ke(i,r))})),t.withIndex(this.index_)}updatePriority(e,t){return e.isEmpty()?g.EMPTY_NODE:e.updatePriority(t)}filtersNodes(){return!1}getIndexedFilter(){return this}getIndex(){return this.index_}}class Xe{constructor(e){this.indexedFilter_=new Cn(e.getIndex()),this.index_=e.getIndex(),this.startPost_=Xe.getStartPost_(e),this.endPost_=Xe.getEndPost_(e),this.startIsInclusive_=!e.startAfterSet_,this.endIsInclusive_=!e.endBeforeSet_}getStartPost(){return this.startPost_}getEndPost(){return this.endPost_}matches(e){const t=this.startIsInclusive_?this.index_.compare(this.getStartPost(),e)<=0:this.index_.compare(this.getStartPost(),e)<0,s=this.endIsInclusive_?this.index_.compare(e,this.getEndPost())<=0:this.index_.compare(e,this.getEndPost())<0;return t&&s}updateChild(e,t,s,i,r,o){return this.matches(new v(t,s))||(s=g.EMPTY_NODE),this.indexedFilter_.updateChild(e,t,s,i,r,o)}updateFullNode(e,t,s){t.isLeafNode()&&(t=g.EMPTY_NODE);let i=t.withIndex(this.index_);i=i.updatePriority(g.EMPTY_NODE);const r=this;return t.forEachChild(S,(o,l)=>{r.matches(new v(o,l))||(i=i.updateImmediateChild(o,g.EMPTY_NODE))}),this.indexedFilter_.updateFullNode(e,i,s)}updatePriority(e,t){return e}filtersNodes(){return!0}getIndexedFilter(){return this.indexedFilter_}getIndex(){return this.index_}static getStartPost_(e){if(e.hasStart()){const t=e.getIndexStartName();return e.getIndex().makePost(e.getIndexStartValue(),t)}return e.getIndex().minPost()}static getEndPost_(e){if(e.hasEnd()){const t=e.getIndexEndName();return e.getIndex().makePost(e.getIndexEndValue(),t)}return e.getIndex().maxPost()}}class Xo{constructor(e){this.withinDirectionalStart=t=>this.reverse_?this.withinEndPost(t):this.withinStartPost(t),this.withinDirectionalEnd=t=>this.reverse_?this.withinStartPost(t):this.withinEndPost(t),this.withinStartPost=t=>{const s=this.index_.compare(this.rangedFilter_.getStartPost(),t);return this.startIsInclusive_?s<=0:s<0},this.withinEndPost=t=>{const s=this.index_.compare(t,this.rangedFilter_.getEndPost());return this.endIsInclusive_?s<=0:s<0},this.rangedFilter_=new Xe(e),this.index_=e.getIndex(),this.limit_=e.getLimit(),this.reverse_=!e.isViewFromLeft(),this.startIsInclusive_=!e.startAfterSet_,this.endIsInclusive_=!e.endBeforeSet_}updateChild(e,t,s,i,r,o){return this.rangedFilter_.matches(new v(t,s))||(s=g.EMPTY_NODE),e.getImmediateChild(t).equals(s)?e:e.numChildren()<this.limit_?this.rangedFilter_.getIndexedFilter().updateChild(e,t,s,i,r,o):this.fullLimitUpdateChild_(e,t,s,r,o)}updateFullNode(e,t,s){let i;if(t.isLeafNode()||t.isEmpty())i=g.EMPTY_NODE.withIndex(this.index_);else if(2*this.limit_<t.numChildren()&&t.isIndexed(this.index_)){let r;i=g.EMPTY_NODE.withIndex(this.index_),r=this.reverse_?t.getReverseIteratorFrom(this.rangedFilter_.getEndPost(),this.index_):t.getIteratorFrom(this.rangedFilter_.getStartPost(),this.index_);let o=0;for(;r.hasNext()&&o<this.limit_;){const l=r.getNext();if(this.withinDirectionalStart(l)){if(!this.withinDirectionalEnd(l))break;i=i.updateImmediateChild(l.name,l.node),o++}}}else{let r;i=t.withIndex(this.index_),i=i.updatePriority(g.EMPTY_NODE),r=this.reverse_?i.getReverseIterator(this.index_):i.getIterator(this.index_);let o=0;for(;r.hasNext();){const l=r.getNext();o<this.limit_&&this.withinDirectionalStart(l)&&this.withinDirectionalEnd(l)?o++:i=i.updateImmediateChild(l.name,g.EMPTY_NODE)}}return this.rangedFilter_.getIndexedFilter().updateFullNode(e,i,s)}updatePriority(e,t){return e}filtersNodes(){return!0}getIndexedFilter(){return this.rangedFilter_.getIndexedFilter()}getIndex(){return this.index_}fullLimitUpdateChild_(e,t,s,i,r){let o;if(this.reverse_){const d=this.index_.getCompare();o=(f,_)=>d(_,f)}else o=this.index_.getCompare();const l=e;(0,c.hu)(l.numChildren()===this.limit_,"");const a=new v(t,s),h=this.reverse_?l.getFirstChild(this.index_):l.getLastChild(this.index_),u=this.rangedFilter_.matches(a);if(l.hasChild(t)){const d=l.getImmediateChild(t);let f=i.getChildAfterChild(this.index_,h,this.reverse_);for(;null!=f&&(f.name===t||l.hasChild(f.name));)f=i.getChildAfterChild(this.index_,f,this.reverse_);const _=null==f?1:o(f,a);if(u&&!s.isEmpty()&&_>=0)return null!=r&&r.trackChildChange(qe(t,s,d)),l.updateImmediateChild(t,s);{null!=r&&r.trackChildChange($e(t,d));const C=l.updateImmediateChild(t,g.EMPTY_NODE);return null!=f&&this.rangedFilter_.matches(f)?(null!=r&&r.trackChildChange(ke(f.name,f.node)),C.updateImmediateChild(f.name,f.node)):C}}return s.isEmpty()?e:u&&o(h,a)>=0?(null!=r&&(r.trackChildChange($e(h.name,h.node)),r.trackChildChange(ke(t,s))),l.updateImmediateChild(t,s).updateImmediateChild(h.name,g.EMPTY_NODE)):e}}class St{constructor(){this.limitSet_=!1,this.startSet_=!1,this.startNameSet_=!1,this.startAfterSet_=!1,this.endSet_=!1,this.endNameSet_=!1,this.endBeforeSet_=!1,this.limit_=0,this.viewFrom_="",this.indexStartValue_=null,this.indexStartName_="",this.indexEndValue_=null,this.indexEndName_="",this.index_=S}hasStart(){return this.startSet_}isViewFromLeft(){return""===this.viewFrom_?this.startSet_:"l"===this.viewFrom_}getIndexStartValue(){return(0,c.hu)(this.startSet_,"Only valid if start has been set"),this.indexStartValue_}getIndexStartName(){return(0,c.hu)(this.startSet_,"Only valid if start has been set"),this.startNameSet_?this.indexStartName_:te}hasEnd(){return this.endSet_}getIndexEndValue(){return(0,c.hu)(this.endSet_,"Only valid if end has been set"),this.indexEndValue_}getIndexEndName(){return(0,c.hu)(this.endSet_,"Only valid if end has been set"),this.endNameSet_?this.indexEndName_:J}hasLimit(){return this.limitSet_}hasAnchoredLimit(){return this.limitSet_&&""!==this.viewFrom_}getLimit(){return(0,c.hu)(this.limitSet_,"Only valid if limit has been set"),this.limit_}getIndex(){return this.index_}loadsAllData(){return!(this.startSet_||this.endSet_||this.limitSet_)}isDefault(){return this.loadsAllData()&&this.index_===S}copy(){const e=new St;return e.limitSet_=this.limitSet_,e.limit_=this.limit_,e.startSet_=this.startSet_,e.startAfterSet_=this.startAfterSet_,e.indexStartValue_=this.indexStartValue_,e.startNameSet_=this.startNameSet_,e.indexStartName_=this.indexStartName_,e.endSet_=this.endSet_,e.endBeforeSet_=this.endBeforeSet_,e.indexEndValue_=this.indexEndValue_,e.endNameSet_=this.endNameSet_,e.indexEndName_=this.indexEndName_,e.index_=this.index_,e.viewFrom_=this.viewFrom_,e}}function wn(n,e,t){const s=n.copy();return s.startSet_=!0,void 0===e&&(e=null),s.indexStartValue_=e,null!=t?(s.startNameSet_=!0,s.indexStartName_=t):(s.startNameSet_=!1,s.indexStartName_=""),s}function En(n,e,t){const s=n.copy();return s.endSet_=!0,void 0===e&&(e=null),s.indexEndValue_=e,void 0!==t?(s.endNameSet_=!0,s.indexEndName_=t):(s.endNameSet_=!1,s.indexEndName_=""),s}function bt(n,e){const t=n.copy();return t.index_=e,t}function ai(n){const e={};if(n.isDefault())return e;let t;if(n.index_===S?t="$priority":n.index_===vn?t="$value":n.index_===z?t="$key":((0,c.hu)(n.index_ instanceof yn,"Unrecognized index type!"),t=n.index_.toString()),e.orderBy=(0,c.Wl)(t),n.startSet_){const s=n.startAfterSet_?"startAfter":"startAt";e[s]=(0,c.Wl)(n.indexStartValue_),n.startNameSet_&&(e[s]+=","+(0,c.Wl)(n.indexStartName_))}if(n.endSet_){const s=n.endBeforeSet_?"endBefore":"endAt";e[s]=(0,c.Wl)(n.indexEndValue_),n.endNameSet_&&(e[s]+=","+(0,c.Wl)(n.indexEndName_))}return n.limitSet_&&(n.isViewFromLeft()?e.limitToFirst=n.limit_:e.limitToLast=n.limit_),e}function ci(n){const e={};if(n.startSet_&&(e.sp=n.indexStartValue_,n.startNameSet_&&(e.sn=n.indexStartName_),e.sin=!n.startAfterSet_),n.endSet_&&(e.ep=n.indexEndValue_,n.endNameSet_&&(e.en=n.indexEndName_),e.ein=!n.endBeforeSet_),n.limitSet_){e.l=n.limit_;let t=n.viewFrom_;""===t&&(t=n.isViewFromLeft()?"l":"r"),e.vf=t}return n.index_!==S&&(e.i=n.index_.toString()),e}class Nt extends js{constructor(e,t,s,i){super(),this.repoInfo_=e,this.onDataUpdate_=t,this.authTokenProvider_=s,this.appCheckTokenProvider_=i,this.log_=Ve("p:rest:"),this.listens_={}}reportStats(e){throw new Error("Method not implemented.")}static getListenId_(e,t){return void 0!==t?"tag$"+t:((0,c.hu)(e._queryParams.isDefault(),"should have a tag if it's not a default query."),e._path.toString())}listen(e,t,s,i){const r=e._path.toString();this.log_("Listen called for "+r+" "+e._queryIdentifier);const o=Nt.getListenId_(e,s),l={};this.listens_[o]=l;const a=ai(e._queryParams);this.restRequest_(r+".json",a,(h,u)=>{let d=u;if(404===h&&(d=null,h=null),null===h&&this.onDataUpdate_(r,d,!1,s),(0,c.DV)(this.listens_,o)===l){let f;f=h?401===h?"permission_denied":"rest_error:"+h:"ok",i(f,null)}})}unlisten(e,t){const s=Nt.getListenId_(e,t);delete this.listens_[s]}get(e){const t=ai(e._queryParams),s=e._path.toString(),i=new c.BH;return this.restRequest_(s+".json",t,(r,o)=>{let l=o;404===r&&(l=null,r=null),null===r?(this.onDataUpdate_(s,l,!1,null),i.resolve(l)):i.reject(new Error(l))}),i.promise}refreshAuthToken(e){}restRequest_(e,t={},s){return t.format="export",Promise.all([this.authTokenProvider_.getToken(!1),this.appCheckTokenProvider_.getToken(!1)]).then(([i,r])=>{i&&i.accessToken&&(t.auth=i.accessToken),r&&r.token&&(t.ac=r.token);const o=(this.repoInfo_.secure?"https://":"http://")+this.repoInfo_.host+e+"?ns="+this.repoInfo_.namespace+(0,c.xO)(t);this.log_("Sending REST request for "+o);const l=new XMLHttpRequest;l.onreadystatechange=()=>{if(s&&4===l.readyState){this.log_("REST Response for "+o+" received. status:",l.status,"response:",l.responseText);let a=null;if(l.status>=200&&l.status<300){try{a=(0,c.cI)(l.responseText)}catch{O("Failed to parse JSON response for "+o+": "+l.responseText)}s(null,a)}else 401!==l.status&&404!==l.status&&O("Got unsuccessful REST response for "+o+" Status: "+l.status),s(l.status);s=null}},l.open("GET",o,!0),l.send()})}}class sl{constructor(){this.rootNode_=g.EMPTY_NODE}getNode(e){return this.rootNode_.getChild(e)}updateSnapshot(e,t){this.rootNode_=this.rootNode_.updateChild(e,t)}}function Rt(){return{value:null,children:new Map}}function Ae(n,e,t){if(y(e))n.value=t,n.children.clear();else if(null!==n.value)n.value=n.value.updateChild(e,t);else{const s=m(e);n.children.has(s)||n.children.set(s,Rt()),Ae(n.children.get(s),e=I(e),t)}}function Tn(n,e){if(y(e))return n.value=null,n.children.clear(),!0;if(null!==n.value){if(n.value.isLeafNode())return!1;{const t=n.value;return n.value=null,t.forEachChild(S,(s,i)=>{Ae(n,new E(s),i)}),Tn(n,e)}}if(n.children.size>0){const t=m(e);return e=I(e),n.children.has(t)&&Tn(n.children.get(t),e)&&n.children.delete(t),0===n.children.size}return!0}function In(n,e,t){null!==n.value?t(e,n.value):function il(n,e){n.children.forEach((t,s)=>{e(s,t)})}(n,(s,i)=>{In(i,new E(e.toString()+"/"+s),t)})}class rl{constructor(e){this.collection_=e,this.last_=null}get(){const e=this.collection_.get(),t=Object.assign({},e);return this.last_&&k(this.last_,(s,i)=>{t[s]=t[s]-i}),this.last_=e,t}}class al{constructor(e,t){this.server_=t,this.statsToReport_={},this.statsListener_=new rl(e);const s=1e4+2e4*Math.random();He(this.reportStats_.bind(this),Math.floor(s))}reportStats_(){const e=this.statsListener_.get(),t={};let s=!1;k(e,(i,r)=>{r>0&&(0,c.r3)(this.statsToReport_,i)&&(t[i]=r,s=!0)}),s&&this.server_.reportStats(t),He(this.reportStats_.bind(this),Math.floor(2*Math.random()*3e5))}}var $=function(n){return n[n.OVERWRITE=0]="OVERWRITE",n[n.MERGE=1]="MERGE",n[n.ACK_USER_WRITE=2]="ACK_USER_WRITE",n[n.LISTEN_COMPLETE=3]="LISTEN_COMPLETE",n}($||{});function Nn(n){return{fromUser:!1,fromServer:!0,queryId:n,tagged:!0}}class Pt{constructor(e,t,s){this.path=e,this.affectedTree=t,this.revert=s,this.type=$.ACK_USER_WRITE,this.source={fromUser:!0,fromServer:!1,queryId:null,tagged:!1}}operationForChild(e){if(y(this.path)){if(null!=this.affectedTree.value)return(0,c.hu)(this.affectedTree.children.isEmpty(),"affectedTree should not have overlapping affected paths."),this;{const t=this.affectedTree.subtree(new E(e));return new Pt(w(),t,this.revert)}}return(0,c.hu)(m(this.path)===e,"operationForChild called for unrelated child."),new Pt(I(this.path),this.affectedTree,this.revert)}}class Je{constructor(e,t){this.source=e,this.path=t,this.type=$.LISTEN_COMPLETE}operationForChild(e){return y(this.path)?new Je(this.source,w()):new Je(this.source,I(this.path))}}class ve{constructor(e,t,s){this.source=e,this.path=t,this.snap=s,this.type=$.OVERWRITE}operationForChild(e){return y(this.path)?new ve(this.source,w(),this.snap.getImmediateChild(e)):new ve(this.source,I(this.path),this.snap)}}class De{constructor(e,t,s){this.source=e,this.path=t,this.children=s,this.type=$.MERGE}operationForChild(e){if(y(this.path)){const t=this.children.subtree(new E(e));return t.isEmpty()?null:t.value?new ve(this.source,w(),t.value):new De(this.source,w(),t)}return(0,c.hu)(m(this.path)===e,"Can't get a merge for a child not on the path of the operation"),new De(this.source,I(this.path),this.children)}toString(){return"Operation("+this.path+": "+this.source.toString()+" merge: "+this.children.toString()+")"}}class ie{constructor(e,t,s){this.node_=e,this.fullyInitialized_=t,this.filtered_=s}isFullyInitialized(){return this.fullyInitialized_}isFiltered(){return this.filtered_}isCompleteForPath(e){if(y(e))return this.isFullyInitialized()&&!this.filtered_;const t=m(e);return this.isCompleteForChild(t)}isCompleteForChild(e){return this.isFullyInitialized()&&!this.filtered_||this.node_.hasChild(e)}getNode(){return this.node_}}class cl{constructor(e){this.query_=e,this.index_=this.query_._queryParams.getIndex()}}function Ze(n,e,t,s,i,r){const o=s.filter(l=>l.type===t);o.sort((l,a)=>function dl(n,e,t){if(null==e.childName||null==t.childName)throw(0,c.g5)("Should only compare child_ events.");const s=new v(e.childName,e.snapshotNode),i=new v(t.childName,t.snapshotNode);return n.index_.compare(s,i)}(n,l,a)),o.forEach(l=>{const a=function ul(n,e,t){return"value"===e.type||"child_removed"===e.type||(e.prevName=t.getPredecessorChildName(e.childName,e.snapshotNode,n.index_)),e}(n,l,r);i.forEach(h=>{h.respondsTo(l.type)&&e.push(h.createEvent(a,n.query_))})})}function xt(n,e){return{eventCache:n,serverCache:e}}function et(n,e,t,s){return xt(new ie(e,t,s),n.serverCache)}function ui(n,e,t,s){return xt(n.eventCache,new ie(e,t,s))}function kt(n){return n.eventCache.isFullyInitialized()?n.eventCache.getNode():null}function Ce(n){return n.serverCache.isFullyInitialized()?n.serverCache.getNode():null}let Rn;class b{constructor(e,t=(()=>(Rn||(Rn=new L($r)),Rn))()){this.value=e,this.children=t}static fromObject(e){let t=new b(null);return k(e,(s,i)=>{t=t.set(new E(s),i)}),t}isEmpty(){return null===this.value&&this.children.isEmpty()}findRootMostMatchingPathAndValue(e,t){if(null!=this.value&&t(this.value))return{path:w(),value:this.value};if(y(e))return null;{const s=m(e),i=this.children.get(s);if(null!==i){const r=i.findRootMostMatchingPathAndValue(I(e),t);return null!=r?{path:N(new E(s),r.path),value:r.value}:null}return null}}findRootMostValueAndPath(e){return this.findRootMostMatchingPathAndValue(e,()=>!0)}subtree(e){if(y(e))return this;{const t=m(e),s=this.children.get(t);return null!==s?s.subtree(I(e)):new b(null)}}set(e,t){if(y(e))return new b(t,this.children);{const s=m(e),r=(this.children.get(s)||new b(null)).set(I(e),t),o=this.children.insert(s,r);return new b(this.value,o)}}remove(e){if(y(e))return this.children.isEmpty()?new b(null):new b(null,this.children);{const t=m(e),s=this.children.get(t);if(s){const i=s.remove(I(e));let r;return r=i.isEmpty()?this.children.remove(t):this.children.insert(t,i),null===this.value&&r.isEmpty()?new b(null):new b(this.value,r)}return this}}get(e){if(y(e))return this.value;{const t=m(e),s=this.children.get(t);return s?s.get(I(e)):null}}setTree(e,t){if(y(e))return t;{const s=m(e),r=(this.children.get(s)||new b(null)).setTree(I(e),t);let o;return o=r.isEmpty()?this.children.remove(s):this.children.insert(s,r),new b(this.value,o)}}fold(e){return this.fold_(w(),e)}fold_(e,t){const s={};return this.children.inorderTraversal((i,r)=>{s[i]=r.fold_(N(e,i),t)}),t(e,this.value,s)}findOnPath(e,t){return this.findOnPath_(e,w(),t)}findOnPath_(e,t,s){const i=!!this.value&&s(t,this.value);if(i)return i;if(y(e))return null;{const r=m(e),o=this.children.get(r);return o?o.findOnPath_(I(e),N(t,r),s):null}}foreachOnPath(e,t){return this.foreachOnPath_(e,w(),t)}foreachOnPath_(e,t,s){if(y(e))return this;{this.value&&s(t,this.value);const i=m(e),r=this.children.get(i);return r?r.foreachOnPath_(I(e),N(t,i),s):new b(null)}}foreach(e){this.foreach_(w(),e)}foreach_(e,t){this.children.inorderTraversal((s,i)=>{i.foreach_(N(e,s),t)}),this.value&&t(e,this.value)}foreachChild(e){this.children.inorderTraversal((t,s)=>{s.value&&e(t,s.value)})}}class Q{constructor(e){this.writeTree_=e}static empty(){return new Q(new b(null))}}function tt(n,e,t){if(y(e))return new Q(new b(t));{const s=n.writeTree_.findRootMostValueAndPath(e);if(null!=s){const i=s.path;let r=s.value;const o=M(i,e);return r=r.updateChild(o,t),new Q(n.writeTree_.set(i,r))}{const i=new b(t),r=n.writeTree_.setTree(e,i);return new Q(r)}}}function Pn(n,e,t){let s=n;return k(t,(i,r)=>{s=tt(s,N(e,i),r)}),s}function di(n,e){if(y(e))return Q.empty();{const t=n.writeTree_.setTree(e,new b(null));return new Q(t)}}function xn(n,e){return null!=we(n,e)}function we(n,e){const t=n.writeTree_.findRootMostValueAndPath(e);return null!=t?n.writeTree_.get(t.path).getChild(M(t.path,e)):null}function fi(n){const e=[],t=n.writeTree_.value;return null!=t?t.isLeafNode()||t.forEachChild(S,(s,i)=>{e.push(new v(s,i))}):n.writeTree_.children.inorderTraversal((s,i)=>{null!=i.value&&e.push(new v(s,i.value))}),e}function re(n,e){if(y(e))return n;{const t=we(n,e);return new Q(null!=t?new b(t):n.writeTree_.subtree(e))}}function kn(n){return n.writeTree_.isEmpty()}function Oe(n,e){return _i(w(),n.writeTree_,e)}function _i(n,e,t){if(null!=e.value)return t.updateChild(n,e.value);{let s=null;return e.children.inorderTraversal((i,r)=>{".priority"===i?((0,c.hu)(null!==r.value,"Priority writes must always be leaf nodes"),s=r.value):t=_i(N(n,i),r,t)}),!t.getChild(n).isEmpty()&&null!==s&&(t=t.updateChild(N(n,".priority"),s)),t}}function At(n,e){return vi(e,n)}function yl(n,e){if(n.snap)return B(n.path,e);for(const t in n.children)if(n.children.hasOwnProperty(t)&&B(N(n.path,t),e))return!0;return!1}function Cl(n){return n.visible}function pi(n,e,t){let s=Q.empty();for(let i=0;i<n.length;++i){const r=n[i];if(e(r)){const o=r.path;let l;if(r.snap)B(t,o)?(l=M(t,o),s=tt(s,l,r.snap)):B(o,t)&&(l=M(o,t),s=tt(s,w(),r.snap.getChild(l)));else{if(!r.children)throw(0,c.g5)("WriteRecord should have .snap or .children");if(B(t,o))l=M(t,o),s=Pn(s,l,r.children);else if(B(o,t))if(l=M(o,t),y(l))s=Pn(s,w(),r.children);else{const a=(0,c.DV)(r.children,m(l));if(a){const h=a.getChild(I(l));s=tt(s,w(),h)}}}}}return s}function gi(n,e,t,s,i){if(s||i){const r=re(n.visibleWrites,e);return!i&&kn(r)?t:i||null!=t||xn(r,w())?Oe(pi(n.allWrites,function(h){return(h.visible||i)&&(!s||!~s.indexOf(h.writeId))&&(B(h.path,e)||B(e,h.path))},e),t||g.EMPTY_NODE):null}{const r=we(n.visibleWrites,e);if(null!=r)return r;{const o=re(n.visibleWrites,e);return kn(o)?t:null!=t||xn(o,w())?Oe(o,t||g.EMPTY_NODE):null}}}function Dt(n,e,t,s){return gi(n.writeTree,n.treePath,e,t,s)}function An(n,e){return function wl(n,e,t){let s=g.EMPTY_NODE;const i=we(n.visibleWrites,e);if(i)return i.isLeafNode()||i.forEachChild(S,(r,o)=>{s=s.updateImmediateChild(r,o)}),s;if(t){const r=re(n.visibleWrites,e);return t.forEachChild(S,(o,l)=>{const a=Oe(re(r,new E(o)),l);s=s.updateImmediateChild(o,a)}),fi(r).forEach(o=>{s=s.updateImmediateChild(o.name,o.node)}),s}return fi(re(n.visibleWrites,e)).forEach(o=>{s=s.updateImmediateChild(o.name,o.node)}),s}(n.writeTree,n.treePath,e)}function mi(n,e,t,s){return function El(n,e,t,s,i){(0,c.hu)(s||i,"Either existingEventSnap or existingServerSnap must exist");const r=N(e,t);if(xn(n.visibleWrites,r))return null;{const o=re(n.visibleWrites,r);return kn(o)?i.getChild(t):Oe(o,i.getChild(t))}}(n.writeTree,n.treePath,e,t,s)}function Ot(n,e){return function Il(n,e){return we(n.visibleWrites,e)}(n.writeTree,N(n.treePath,e))}function Dn(n,e,t){return function Tl(n,e,t,s){const i=N(e,t),r=we(n.visibleWrites,i);return null!=r?r:s.isCompleteForChild(t)?Oe(re(n.visibleWrites,i),s.getNode().getImmediateChild(t)):null}(n.writeTree,n.treePath,e,t)}function yi(n,e){return vi(N(n.treePath,e),n.writeTree)}function vi(n,e){return{treePath:n,writeTree:e}}class Rl{constructor(){this.changeMap=new Map}trackChildChange(e){const t=e.type,s=e.childName;(0,c.hu)("child_added"===t||"child_changed"===t||"child_removed"===t,"Only child changes supported for tracking"),(0,c.hu)(".priority"!==s,"Only non-priority child changes can be tracked.");const i=this.changeMap.get(s);if(i){const r=i.type;if("child_added"===t&&"child_removed"===r)this.changeMap.set(s,qe(s,e.snapshotNode,i.snapshotNode));else if("child_removed"===t&&"child_added"===r)this.changeMap.delete(s);else if("child_removed"===t&&"child_changed"===r)this.changeMap.set(s,$e(s,i.oldSnap));else if("child_changed"===t&&"child_added"===r)this.changeMap.set(s,ke(s,e.snapshotNode));else{if("child_changed"!==t||"child_changed"!==r)throw(0,c.g5)("Illegal combination of changes: "+e+" occurred after "+i);this.changeMap.set(s,qe(s,e.snapshotNode,i.oldSnap))}}else this.changeMap.set(s,e)}getChanges(){return Array.from(this.changeMap.values())}}const Ci=new class Pl{getCompleteChild(e){return null}getChildAfterChild(e,t,s){return null}};class On{constructor(e,t,s=null){this.writes_=e,this.viewCache_=t,this.optCompleteServerCache_=s}getCompleteChild(e){const t=this.viewCache_.eventCache;if(t.isCompleteForChild(e))return t.getNode().getImmediateChild(e);{const s=null!=this.optCompleteServerCache_?new ie(this.optCompleteServerCache_,!0,!1):this.viewCache_.serverCache;return Dn(this.writes_,e,s)}}getChildAfterChild(e,t,s){const i=null!=this.optCompleteServerCache_?this.optCompleteServerCache_:Ce(this.viewCache_),r=function Nl(n,e,t,s,i,r){return function Sl(n,e,t,s,i,r,o){let l;const a=re(n.visibleWrites,e),h=we(a,w());if(null!=h)l=h;else{if(null==t)return[];l=Oe(a,t)}if(l=l.withIndex(o),l.isEmpty()||l.isLeafNode())return[];{const u=[],d=o.getCompare(),f=r?l.getReverseIteratorFrom(s,o):l.getIteratorFrom(s,o);let _=f.getNext();for(;_&&u.length<i;)0!==d(_,s)&&u.push(_),_=f.getNext();return u}}(n.writeTree,n.treePath,e,t,s,i,r)}(this.writes_,i,t,1,s,e);return 0===r.length?null:r[0]}}function wi(n,e,t,s,i,r){const o=e.eventCache;if(null!=Ot(s,t))return e;{let l,a;if(y(t))if((0,c.hu)(e.serverCache.isFullyInitialized(),"If change path is empty, we must have complete server data"),e.serverCache.isFiltered()){const h=Ce(e),d=An(s,h instanceof g?h:g.EMPTY_NODE);l=n.filter.updateFullNode(e.eventCache.getNode(),d,r)}else{const h=Dt(s,Ce(e));l=n.filter.updateFullNode(e.eventCache.getNode(),h,r)}else{const h=m(t);if(".priority"===h){(0,c.hu)(1===se(t),"Can't have a priority with additional path components");const u=o.getNode();a=e.serverCache.getNode();const d=mi(s,t,u,a);l=null!=d?n.filter.updatePriority(u,d):o.getNode()}else{const u=I(t);let d;if(o.isCompleteForChild(h)){a=e.serverCache.getNode();const f=mi(s,t,o.getNode(),a);d=null!=f?o.getNode().getImmediateChild(h).updateChild(u,f):o.getNode().getImmediateChild(h)}else d=Dn(s,h,e.serverCache);l=null!=d?n.filter.updateChild(o.getNode(),h,d,u,i,r):o.getNode()}}return et(e,l,o.isFullyInitialized()||y(t),n.filter.filtersNodes())}}function Mt(n,e,t,s,i,r,o,l){const a=e.serverCache;let h;const u=o?n.filter:n.filter.getIndexedFilter();if(y(t))h=u.updateFullNode(a.getNode(),s,null);else if(u.filtersNodes()&&!a.isFiltered()){const _=a.getNode().updateChild(t,s);h=u.updateFullNode(a.getNode(),_,null)}else{const _=m(t);if(!a.isCompleteForPath(t)&&se(t)>1)return e;const p=I(t),A=a.getNode().getImmediateChild(_).updateChild(p,s);h=".priority"===_?u.updatePriority(a.getNode(),A):u.updateChild(a.getNode(),_,A,p,Ci,null)}const d=ui(e,h,a.isFullyInitialized()||y(t),u.filtersNodes());return wi(n,d,t,i,new On(i,d,r),l)}function Mn(n,e,t,s,i,r,o){const l=e.eventCache;let a,h;const u=new On(i,e,r);if(y(t))h=n.filter.updateFullNode(e.eventCache.getNode(),s,o),a=et(e,h,!0,n.filter.filtersNodes());else{const d=m(t);if(".priority"===d)h=n.filter.updatePriority(e.eventCache.getNode(),s),a=et(e,h,l.isFullyInitialized(),l.isFiltered());else{const f=I(t),_=l.getNode().getImmediateChild(d);let p;if(y(f))p=s;else{const C=u.getCompleteChild(d);p=null!=C?".priority"===dn(f)&&C.getChild(Xs(f)).isEmpty()?C:C.updateChild(f,s):g.EMPTY_NODE}a=_.equals(p)?e:et(e,n.filter.updateChild(l.getNode(),d,p,f,u,o),l.isFullyInitialized(),n.filter.filtersNodes())}}return a}function Ei(n,e){return n.eventCache.isCompleteForChild(e)}function Ti(n,e,t){return t.foreach((s,i)=>{e=e.updateChild(s,i)}),e}function Ln(n,e,t,s,i,r,o,l){if(e.serverCache.getNode().isEmpty()&&!e.serverCache.isFullyInitialized())return e;let h,a=e;h=y(t)?s:new b(null).setTree(t,s);const u=e.serverCache.getNode();return h.children.inorderTraversal((d,f)=>{if(u.hasChild(d)){const p=Ti(0,e.serverCache.getNode().getImmediateChild(d),f);a=Mt(n,a,new E(d),p,i,r,o,l)}}),h.children.inorderTraversal((d,f)=>{const _=!e.serverCache.isCompleteForChild(d)&&null===f.value;if(!u.hasChild(d)&&!_){const C=Ti(0,e.serverCache.getNode().getImmediateChild(d),f);a=Mt(n,a,new E(d),C,i,r,o,l)}}),a}class Wl{constructor(e,t){this.query_=e,this.eventRegistrations_=[];const s=this.query_._queryParams,i=new Cn(s.getIndex()),r=function Jo(n){return n.loadsAllData()?new Cn(n.getIndex()):n.hasLimit()?new Xo(n):new Xe(n)}(s);this.processor_=function xl(n){return{filter:n}}(r);const o=t.serverCache,l=t.eventCache,a=i.updateFullNode(g.EMPTY_NODE,o.getNode(),null),h=r.updateFullNode(g.EMPTY_NODE,l.getNode(),null),u=new ie(a,o.isFullyInitialized(),i.filtersNodes()),d=new ie(h,l.isFullyInitialized(),r.filtersNodes());this.viewCache_=xt(d,u),this.eventGenerator_=new cl(this.query_)}get query(){return this.query_}}function Vl(n,e){const t=Ce(n.viewCache_);return t&&(n.query._queryParams.loadsAllData()||!y(e)&&!t.getImmediateChild(m(e)).isEmpty())?t.getChild(e):null}function Ii(n){return 0===n.eventRegistrations_.length}function Si(n,e,t){const s=[];if(t){(0,c.hu)(null==e,"A cancel should cancel all event registrations.");const i=n.query._path;n.eventRegistrations_.forEach(r=>{const o=r.createCancelEvent(t,i);o&&s.push(o)})}if(e){let i=[];for(let r=0;r<n.eventRegistrations_.length;++r){const o=n.eventRegistrations_[r];if(o.matches(e)){if(e.hasAnyCallback()){i=i.concat(n.eventRegistrations_.slice(r+1));break}}else i.push(o)}n.eventRegistrations_=i}else n.eventRegistrations_=[];return s}function bi(n,e,t,s){e.type===$.MERGE&&null!==e.source.queryId&&((0,c.hu)(Ce(n.viewCache_),"We should always have a full cache before handling merges"),(0,c.hu)(kt(n.viewCache_),"Missing event cache, even though we have a server cache"));const i=n.viewCache_,r=function Al(n,e,t,s,i){const r=new Rl;let o,l;if(t.type===$.OVERWRITE){const h=t;h.source.fromUser?o=Mn(n,e,h.path,h.snap,s,i,r):((0,c.hu)(h.source.fromServer,"Unknown source."),l=h.source.tagged||e.serverCache.isFiltered()&&!y(h.path),o=Mt(n,e,h.path,h.snap,s,i,l,r))}else if(t.type===$.MERGE){const h=t;h.source.fromUser?o=function Ol(n,e,t,s,i,r,o){let l=e;return s.foreach((a,h)=>{const u=N(t,a);Ei(e,m(u))&&(l=Mn(n,l,u,h,i,r,o))}),s.foreach((a,h)=>{const u=N(t,a);Ei(e,m(u))||(l=Mn(n,l,u,h,i,r,o))}),l}(n,e,h.path,h.children,s,i,r):((0,c.hu)(h.source.fromServer,"Unknown source."),l=h.source.tagged||e.serverCache.isFiltered(),o=Ln(n,e,h.path,h.children,s,i,l,r))}else if(t.type===$.ACK_USER_WRITE){const h=t;o=h.revert?function Fl(n,e,t,s,i,r){let o;if(null!=Ot(s,t))return e;{const l=new On(s,e,i),a=e.eventCache.getNode();let h;if(y(t)||".priority"===m(t)){let u;if(e.serverCache.isFullyInitialized())u=Dt(s,Ce(e));else{const d=e.serverCache.getNode();(0,c.hu)(d instanceof g,"serverChildren would be complete if leaf node"),u=An(s,d)}h=n.filter.updateFullNode(a,u,r)}else{const u=m(t);let d=Dn(s,u,e.serverCache);null==d&&e.serverCache.isCompleteForChild(u)&&(d=a.getImmediateChild(u)),h=null!=d?n.filter.updateChild(a,u,d,I(t),l,r):e.eventCache.getNode().hasChild(u)?n.filter.updateChild(a,u,g.EMPTY_NODE,I(t),l,r):a,h.isEmpty()&&e.serverCache.isFullyInitialized()&&(o=Dt(s,Ce(e)),o.isLeafNode()&&(h=n.filter.updateFullNode(h,o,r)))}return o=e.serverCache.isFullyInitialized()||null!=Ot(s,w()),et(e,h,o,n.filter.filtersNodes())}}(n,e,h.path,s,i,r):function Ml(n,e,t,s,i,r,o){if(null!=Ot(i,t))return e;const l=e.serverCache.isFiltered(),a=e.serverCache;if(null!=s.value){if(y(t)&&a.isFullyInitialized()||a.isCompleteForPath(t))return Mt(n,e,t,a.getNode().getChild(t),i,r,l,o);if(y(t)){let h=new b(null);return a.getNode().forEachChild(z,(u,d)=>{h=h.set(new E(u),d)}),Ln(n,e,t,h,i,r,l,o)}return e}{let h=new b(null);return s.foreach((u,d)=>{const f=N(t,u);a.isCompleteForPath(f)&&(h=h.set(u,a.getNode().getChild(f)))}),Ln(n,e,t,h,i,r,l,o)}}(n,e,h.path,h.affectedTree,s,i,r)}else{if(t.type!==$.LISTEN_COMPLETE)throw(0,c.g5)("Unknown operation type: "+t.type);o=function Ll(n,e,t,s,i){const r=e.serverCache;return wi(n,ui(e,r.getNode(),r.isFullyInitialized()||y(t),r.isFiltered()),t,s,Ci,i)}(n,e,t.path,s,r)}const a=r.getChanges();return function Dl(n,e,t){const s=e.eventCache;if(s.isFullyInitialized()){const i=s.getNode().isLeafNode()||s.getNode().isEmpty(),r=kt(n);(t.length>0||!n.eventCache.isFullyInitialized()||i&&!s.getNode().equals(r)||!s.getNode().getPriority().equals(r.getPriority()))&&t.push(li(kt(e)))}}(e,o,a),{viewCache:o,changes:a}}(n.processor_,i,e,t,s);return function kl(n,e){(0,c.hu)(e.eventCache.getNode().isIndexed(n.filter.getIndex()),"Event snap not indexed"),(0,c.hu)(e.serverCache.getNode().isIndexed(n.filter.getIndex()),"Server snap not indexed")}(n.processor_,r.viewCache),(0,c.hu)(r.viewCache.serverCache.isFullyInitialized()||!i.serverCache.isFullyInitialized(),"Once a server snap is complete, it should never go back"),n.viewCache_=r.viewCache,Ni(n,r.changes,r.viewCache.eventCache.getNode(),null)}function Ni(n,e,t,s){return function hl(n,e,t,s){const i=[],r=[];return e.forEach(o=>{"child_changed"===o.type&&n.index_.indexedValueChanged(o.oldSnap,o.snapshotNode)&&r.push(function qo(n,e){return{type:"child_moved",snapshotNode:e,childName:n}}(o.childName,o.snapshotNode))}),Ze(n,i,"child_removed",e,s,t),Ze(n,i,"child_added",e,s,t),Ze(n,i,"child_moved",r,s,t),Ze(n,i,"child_changed",e,s,t),Ze(n,i,"value",e,s,t),i}(n.eventGenerator_,e,t,s?[s]:n.eventRegistrations_)}let Lt,Wt;class Ri{constructor(){this.views=new Map}}function Fn(n,e,t,s){const i=e.source.queryId;if(null!==i){const r=n.views.get(i);return(0,c.hu)(null!=r,"SyncTree gave us an op for an invalid query."),bi(r,e,t,s)}{let r=[];for(const o of n.views.values())r=r.concat(bi(o,e,t,s));return r}}function Pi(n,e,t,s,i){const o=n.views.get(e._queryIdentifier);if(!o){let l=Dt(t,i?s:null),a=!1;l?a=!0:s instanceof g?(l=An(t,s),a=!1):(l=g.EMPTY_NODE,a=!1);const h=xt(new ie(l,a,!1),new ie(s,i,!1));return new Wl(e,h)}return o}function xi(n){const e=[];for(const t of n.views.values())t.query._queryParams.loadsAllData()||e.push(t);return e}function oe(n,e){let t=null;for(const s of n.views.values())t=t||Vl(s,e);return t}function ki(n,e){return e._queryParams.loadsAllData()?Ft(n):n.views.get(e._queryIdentifier)}function Ai(n,e){return null!=ki(n,e)}function le(n){return null!=Ft(n)}function Ft(n){for(const e of n.views.values())if(e.query._queryParams.loadsAllData())return e;return null}let Xl=1;class Di{constructor(e){this.listenProvider_=e,this.syncPointTree_=new b(null),this.pendingWriteTree_=function bl(){return{visibleWrites:Q.empty(),allWrites:[],lastWriteId:-1}}(),this.tagToQueryMap=new Map,this.queryToTagMap=new Map}}function Wn(n,e,t,s,i){return function _l(n,e,t,s,i){(0,c.hu)(s>n.lastWriteId,"Stacking an older write on top of newer ones"),void 0===i&&(i=!0),n.allWrites.push({path:e,snap:t,writeId:s,visible:i}),i&&(n.visibleWrites=tt(n.visibleWrites,e,t)),n.lastWriteId=s}(n.pendingWriteTree_,e,t,s,i),i?Me(n,new ve({fromUser:!0,fromServer:!1,queryId:null,tagged:!1},e,t)):[]}function ae(n,e,t=!1){const s=function gl(n,e){for(let t=0;t<n.allWrites.length;t++){const s=n.allWrites[t];if(s.writeId===e)return s}return null}(n.pendingWriteTree_,e);if(function ml(n,e){const t=n.allWrites.findIndex(l=>l.writeId===e);(0,c.hu)(t>=0,"removeWrite called with nonexistent writeId.");const s=n.allWrites[t];n.allWrites.splice(t,1);let i=s.visible,r=!1,o=n.allWrites.length-1;for(;i&&o>=0;){const l=n.allWrites[o];l.visible&&(o>=t&&yl(l,s.path)?i=!1:B(s.path,l.path)&&(r=!0)),o--}return!!i&&(r?(function vl(n){n.visibleWrites=pi(n.allWrites,Cl,w()),n.lastWriteId=n.allWrites.length>0?n.allWrites[n.allWrites.length-1].writeId:-1}(n),!0):(s.snap?n.visibleWrites=di(n.visibleWrites,s.path):k(s.children,a=>{n.visibleWrites=di(n.visibleWrites,N(s.path,a))}),!0))}(n.pendingWriteTree_,e)){let r=new b(null);return null!=s.snap?r=r.set(w(),!0):k(s.children,o=>{r=r.set(new E(o),!0)}),Me(n,new Pt(s.path,r,t))}return[]}function nt(n,e,t){return Me(n,new ve({fromUser:!1,fromServer:!0,queryId:null,tagged:!1},e,t))}function Ut(n,e,t,s,i=!1){const r=e._path,o=n.syncPointTree_.get(r);let l=[];if(o&&("default"===e._queryIdentifier||Ai(o,e))){const a=function zl(n,e,t,s){const i=e._queryIdentifier,r=[];let o=[];const l=le(n);if("default"===i)for(const[a,h]of n.views.entries())o=o.concat(Si(h,t,s)),Ii(h)&&(n.views.delete(a),h.query._queryParams.loadsAllData()||r.push(h.query));else{const a=n.views.get(i);a&&(o=o.concat(Si(a,t,s)),Ii(a)&&(n.views.delete(i),a.query._queryParams.loadsAllData()||r.push(a.query)))}return l&&!le(n)&&r.push(new(function Kl(){return(0,c.hu)(Lt,"Reference.ts has not been loaded"),Lt}())(e._repo,e._path)),{removed:r,events:o}}(o,e,t,s);(function Yl(n){return 0===n.views.size})(o)&&(n.syncPointTree_=n.syncPointTree_.remove(r));const h=a.removed;if(l=a.events,!i){const u=-1!==h.findIndex(f=>f._queryParams.loadsAllData()),d=n.syncPointTree_.findOnPath(r,(f,_)=>le(_));if(u&&!d){const f=n.syncPointTree_.subtree(r);if(!f.isEmpty()){const _=function ia(n){return n.fold((e,t,s)=>{if(t&&le(t))return[Ft(t)];{let i=[];return t&&(i=xi(t)),k(s,(r,o)=>{i=i.concat(o)}),i}})}(f);for(let p=0;p<_.length;++p){const C=_[p],A=C.query,X=Fi(n,C);n.listenProvider_.startListening(it(A),st(n,A),X.hashFn,X.onComplete)}}}!d&&h.length>0&&!s&&(u?n.listenProvider_.stopListening(it(e),null):h.forEach(f=>{const _=n.queryToTagMap.get(Vt(f));n.listenProvider_.stopListening(it(f),_)}))}!function ra(n,e){for(let t=0;t<e.length;++t){const s=e[t];if(!s._queryParams.loadsAllData()){const i=Vt(s),r=n.queryToTagMap.get(i);n.queryToTagMap.delete(i),n.tagToQueryMap.delete(r)}}}(n,h)}return l}function Oi(n,e,t,s){const i=Bn(n,s);if(null!=i){const r=Vn(i),o=r.path,l=r.queryId,a=M(o,e);return Gn(n,o,new ve(Nn(l),a,t))}return[]}function Un(n,e,t,s=!1){const i=e._path;let r=null,o=!1;n.syncPointTree_.foreachOnPath(i,(f,_)=>{const p=M(f,i);r=r||oe(_,p),o=o||le(_)});let a,l=n.syncPointTree_.get(i);l?(o=o||le(l),r=r||oe(l,w())):(l=new Ri,n.syncPointTree_=n.syncPointTree_.set(i,l)),null!=r?a=!0:(a=!1,r=g.EMPTY_NODE,n.syncPointTree_.subtree(i).foreachChild((_,p)=>{const C=oe(p,w());C&&(r=r.updateImmediateChild(_,C))}));const h=Ai(l,e);if(!h&&!e._queryParams.loadsAllData()){const f=Vt(e);(0,c.hu)(!n.queryToTagMap.has(f),"View does not exist, but we have a tag");const _=function oa(){return Xl++}();n.queryToTagMap.set(f,_),n.tagToQueryMap.set(_,f)}let d=function jl(n,e,t,s,i,r){const o=Pi(n,e,s,i,r);return n.views.has(e._queryIdentifier)||n.views.set(e._queryIdentifier,o),function Gl(n,e){n.eventRegistrations_.push(e)}(o,t),function Hl(n,e){const t=n.viewCache_.eventCache,s=[];return t.getNode().isLeafNode()||t.getNode().forEachChild(S,(r,o)=>{s.push(ke(r,o))}),t.isFullyInitialized()&&s.push(li(t.getNode())),Ni(n,s,t.getNode(),e)}(o,t)}(l,e,t,At(n.pendingWriteTree_,i),r,a);if(!h&&!o&&!s){const f=ki(l,e);d=d.concat(function la(n,e,t){const s=e._path,i=st(n,e),r=Fi(n,t),o=n.listenProvider_.startListening(it(e),i,r.hashFn,r.onComplete),l=n.syncPointTree_.subtree(s);if(i)(0,c.hu)(!le(l.value),"If we're adding a query, it shouldn't be shadowed");else{const a=l.fold((h,u,d)=>{if(!y(h)&&u&&le(u))return[Ft(u).query];{let f=[];return u&&(f=f.concat(xi(u).map(_=>_.query))),k(d,(_,p)=>{f=f.concat(p)}),f}});for(let h=0;h<a.length;++h){const u=a[h];n.listenProvider_.stopListening(it(u),st(n,u))}}return o}(n,e,f))}return d}function Bt(n,e,t){const i=n.pendingWriteTree_,r=n.syncPointTree_.findOnPath(e,(o,l)=>{const h=oe(l,M(o,e));if(h)return h});return gi(i,e,r,t,!0)}function Me(n,e){return Mi(e,n.syncPointTree_,null,At(n.pendingWriteTree_,w()))}function Mi(n,e,t,s){if(y(n.path))return Li(n,e,t,s);{const i=e.get(w());null==t&&null!=i&&(t=oe(i,w()));let r=[];const o=m(n.path),l=n.operationForChild(o),a=e.children.get(o);if(a&&l){const h=t?t.getImmediateChild(o):null,u=yi(s,o);r=r.concat(Mi(l,a,h,u))}return i&&(r=r.concat(Fn(i,n,s,t))),r}}function Li(n,e,t,s){const i=e.get(w());null==t&&null!=i&&(t=oe(i,w()));let r=[];return e.children.inorderTraversal((o,l)=>{const a=t?t.getImmediateChild(o):null,h=yi(s,o),u=n.operationForChild(o);u&&(r=r.concat(Li(u,l,a,h)))}),i&&(r=r.concat(Fn(i,n,s,t))),r}function Fi(n,e){const t=e.query,s=st(n,t);return{hashFn:()=>(function Ul(n){return n.viewCache_.serverCache.getNode()}(e)||g.EMPTY_NODE).hash(),onComplete:i=>{if("ok"===i)return s?function ta(n,e,t){const s=Bn(n,t);if(s){const i=Vn(s),r=i.path,o=i.queryId,l=M(r,e);return Gn(n,r,new Je(Nn(o),l))}return[]}(n,t._path,s):function ea(n,e){return Me(n,new Je({fromUser:!1,fromServer:!0,queryId:null,tagged:!1},e))}(n,t._path);{const r=function Jr(n,e){let t="Unknown Error";"too_big"===n?t="The data requested exceeds the maximum size that can be accessed with a single request.":"permission_denied"===n?t="Client doesn't have permission to access the desired data.":"unavailable"===n&&(t="The service is unavailable");const s=new Error(n+" at "+e._path.toString()+": "+t);return s.code=n.toUpperCase(),s}(i,t);return Ut(n,t,null,r)}}}}function st(n,e){const t=Vt(e);return n.queryToTagMap.get(t)}function Vt(n){return n._path.toString()+"$"+n._queryIdentifier}function Bn(n,e){return n.tagToQueryMap.get(e)}function Vn(n){const e=n.indexOf("$");return(0,c.hu)(-1!==e&&e<n.length-1,"Bad queryKey."),{queryId:n.substr(e+1),path:new E(n.substr(0,e))}}function Gn(n,e,t){const s=n.syncPointTree_.get(e);return(0,c.hu)(s,"Missing sync point for query tag that we're tracking"),Fn(s,t,At(n.pendingWriteTree_,e),null)}function it(n){return n._queryParams.loadsAllData()&&!n._queryParams.isDefault()?new(function ql(){return(0,c.hu)(Wt,"Reference.ts has not been loaded"),Wt}())(n._repo,n._path):n}class Hn{constructor(e){this.node_=e}getImmediateChild(e){const t=this.node_.getImmediateChild(e);return new Hn(t)}node(){return this.node_}}class Qn{constructor(e,t){this.syncTree_=e,this.path_=t}getImmediateChild(e){const t=N(this.path_,e);return new Qn(this.syncTree_,t)}node(){return Bt(this.syncTree_,this.path_)}}const aa=function(n){return(n=n||{}).timestamp=n.timestamp||(new Date).getTime(),n},Wi=function(n,e,t){return n&&"object"==typeof n?((0,c.hu)(".sv"in n,"Unexpected leaf node or priority contents"),"string"==typeof n[".sv"]?ca(n[".sv"],e,t):"object"==typeof n[".sv"]?ha(n[".sv"],e):void(0,c.hu)(!1,"Unexpected server value: "+JSON.stringify(n,null,2))):n},ca=function(n,e,t){if("timestamp"===n)return t.timestamp;(0,c.hu)(!1,"Unexpected server value: "+n)},ha=function(n,e,t){n.hasOwnProperty("increment")||(0,c.hu)(!1,"Unexpected server value: "+JSON.stringify(n,null,2));const s=n.increment;"number"!=typeof s&&(0,c.hu)(!1,"Unexpected increment value: "+s);const i=e.node();if((0,c.hu)(null!==i&&typeof i<"u","Expected ChildrenNode.EMPTY_NODE for nulls"),!i.isLeafNode())return s;const o=i.getValue();return"number"!=typeof o?s:o+s},Ui=function(n,e,t,s){return Yn(e,new Qn(t,n),s)},Kn=function(n,e,t){return Yn(n,new Hn(e),t)};function Yn(n,e,t){const s=n.getPriority().val(),i=Wi(s,e.getImmediateChild(".priority"),t);let r;if(n.isLeafNode()){const o=n,l=Wi(o.getValue(),e,t);return l!==o.getValue()||i!==o.getPriority().val()?new Pe(l,R(i)):n}{const o=n;return r=o,i!==o.getPriority().val()&&(r=r.updatePriority(new Pe(i))),o.forEachChild(S,(l,a)=>{const h=Yn(a,e.getImmediateChild(l),t);h!==a&&(r=r.updateImmediateChild(l,h))}),r}}class jn{constructor(e="",t=null,s={children:{},childCount:0}){this.name=e,this.parent=t,this.node=s}}function Gt(n,e){let t=e instanceof E?e:new E(e),s=n,i=m(t);for(;null!==i;){const r=(0,c.DV)(s.node.children,i)||{children:{},childCount:0};s=new jn(i,s,r),t=I(t),i=m(t)}return s}function Ee(n){return n.node.value}function zn(n,e){n.node.value=e,$n(n)}function Bi(n){return n.node.childCount>0}function Ht(n,e){k(n.node.children,(t,s)=>{e(new jn(t,n,s))})}function Vi(n,e,t,s){t&&!s&&e(n),Ht(n,i=>{Vi(i,e,!0,s)}),t&&s&&e(n)}function rt(n){return new E(null===n.parent?n.name:rt(n.parent)+"/"+n.name)}function $n(n){null!==n.parent&&function fa(n,e,t){const s=function ua(n){return void 0===Ee(n)&&!Bi(n)}(t),i=(0,c.r3)(n.node.children,e);s&&i?(delete n.node.children[e],n.node.childCount--,$n(n)):!s&&!i&&(n.node.children[e]=t.node,n.node.childCount++,$n(n))}(n.parent,n.name,n)}const _a=/[\[\].#$\/\u0000-\u001F\u007F]/,pa=/[\[\].#$\u0000-\u001F\u007F]/,qn=10485760,Qt=function(n){return"string"==typeof n&&0!==n.length&&!_a.test(n)},Gi=function(n){return"string"==typeof n&&0!==n.length&&!pa.test(n)},ot=function(n){return null===n||"string"==typeof n||"number"==typeof n&&!mt(n)||n&&"object"==typeof n&&(0,c.r3)(n,".sv")},q=function(n,e,t,s){s&&void 0===e||lt((0,c.gK)(n,"value"),e,t)},lt=function(n,e,t){const s=t instanceof E?new Ao(t,n):t;if(void 0===e)throw new Error(n+"contains undefined "+me(s));if("function"==typeof e)throw new Error(n+"contains a function "+me(s)+" with contents = "+e.toString());if(mt(e))throw new Error(n+"contains "+e.toString()+" "+me(s));if("string"==typeof e&&e.length>qn/3&&(0,c.ug)(e)>qn)throw new Error(n+"contains a string greater than "+qn+" utf8 bytes "+me(s)+" ('"+e.substring(0,50)+"...')");if(e&&"object"==typeof e){let i=!1,r=!1;if(k(e,(o,l)=>{if(".value"===o)i=!0;else if(".priority"!==o&&".sv"!==o&&(r=!0,!Qt(o)))throw new Error(n+" contains an invalid key ("+o+") "+me(s)+'.  Keys must be non-empty strings and can\'t contain ".", "#", "$", "/", "[", or "]"');(function Do(n,e){n.parts_.length>0&&(n.byteLength_+=1),n.parts_.push(e),n.byteLength_+=(0,c.ug)(e),Js(n)})(s,o),lt(n,l,s),function Oo(n){const e=n.parts_.pop();n.byteLength_-=(0,c.ug)(e),n.parts_.length>0&&(n.byteLength_-=1)}(s)}),i&&r)throw new Error(n+' contains ".value" child '+me(s)+" in addition to actual children.")}},Hi=function(n,e,t,s){if(s&&void 0===e)return;const i=(0,c.gK)(n,"values");if(!e||"object"!=typeof e||Array.isArray(e))throw new Error(i+" must be an object containing the children to replace.");const r=[];k(e,(o,l)=>{const a=new E(o);if(lt(i,l,N(t,a)),".priority"===dn(a)&&!ot(l))throw new Error(i+"contains an invalid value for '"+a.toString()+"', which must be a valid Firebase priority (a string, finite number, server value, or null).");r.push(a)}),function(n,e){let t,s;for(t=0;t<e.length;t++){s=e[t];const r=Ke(s);for(let o=0;o<r.length;o++)if((".priority"!==r[o]||o!==r.length-1)&&!Qt(r[o]))throw new Error(n+"contains an invalid key ("+r[o]+") in path "+s.toString()+'. Keys must be non-empty strings and can\'t contain ".", "#", "$", "/", "[", or "]"')}e.sort(ko);let i=null;for(t=0;t<e.length;t++){if(s=e[t],null!==i&&B(i,s))throw new Error(n+"contains a path "+i.toString()+" that is ancestor of another path "+s.toString());i=s}}(i,r)},Xn=function(n,e,t){if(!t||void 0!==e){if(mt(e))throw new Error((0,c.gK)(n,"priority")+"is "+e.toString()+", but must be a valid Firebase priority (a string, finite number, server value, or null).");if(!ot(e))throw new Error((0,c.gK)(n,"priority")+"must be a valid Firebase priority (a string, finite number, server value, or null).")}},at=function(n,e,t,s){if(!(s&&void 0===t||Qt(t)))throw new Error((0,c.gK)(n,e)+'was an invalid key = "'+t+'".  Firebase keys must be non-empty strings and can\'t contain ".", "#", "$", "/", "[", or "]").')},ct=function(n,e,t,s){if(!(s&&void 0===t||Gi(t)))throw new Error((0,c.gK)(n,e)+'was an invalid path = "'+t+'". Paths must be non-empty strings and can\'t contain ".", "#", "$", "[", or "]"')},ya=function(n,e,t,s){t&&(t=t.replace(/^\/*\.info(\/|$)/,"/")),ct(n,e,t,s)},V=function(n,e){if(".info"===m(e))throw new Error(n+" failed = Can't modify data under /.info/")},Qi=function(n,e){const t=e.path.toString();if("string"!=typeof e.repoInfo.host||0===e.repoInfo.host.length||!Qt(e.repoInfo.namespace)&&"localhost"!==e.repoInfo.host.split(":")[0]||0!==t.length&&!function(n){return n&&(n=n.replace(/^\/*\.info(\/|$)/,"/")),Gi(n)}(t))throw new Error((0,c.gK)(n,"url")+'must be a valid firebase URL and the path can\'t contain ".", "#", "$", "[", or "]".')};class va{constructor(){this.eventLists_=[],this.recursionDepth_=0}}function Kt(n,e){let t=null;for(let s=0;s<e.length;s++){const i=e[s],r=i.getPath();null!==t&&!fn(r,t.path)&&(n.eventLists_.push(t),t=null),null===t&&(t={events:[],path:r}),t.events.push(i)}t&&n.eventLists_.push(t)}function Ki(n,e,t){Kt(n,t),Yi(n,s=>fn(s,e))}function W(n,e,t){Kt(n,t),Yi(n,s=>B(s,e)||B(e,s))}function Yi(n,e){n.recursionDepth_++;let t=!0;for(let s=0;s<n.eventLists_.length;s++){const i=n.eventLists_[s];i&&(e(i.path)?(Ca(n.eventLists_[s]),n.eventLists_[s]=null):t=!1)}t&&(n.eventLists_=[]),n.recursionDepth_--}function Ca(n){for(let e=0;e<n.events.length;e++){const t=n.events[e];if(null!==t){n.events[e]=null;const s=t.getEventRunner();pe&&x("event: "+t.toString()),Ne(s)}}}const ji="repo_interrupt",wa=25;class Ea{constructor(e,t,s,i){this.repoInfo_=e,this.forceRestClient_=t,this.authTokenProvider_=s,this.appCheckProvider_=i,this.dataUpdateCount=0,this.statsListener_=null,this.eventQueue_=new va,this.nextWriteId_=1,this.interceptServerDataCallback_=null,this.onDisconnect_=Rt(),this.transactionQueueTree_=new jn,this.persistentConnection_=null,this.key=this.repoInfo_.toURLString()}toString(){return(this.repoInfo_.secure?"https://":"http://")+this.repoInfo_.host}}function zi(n){const t=n.infoData_.getNode(new E(".info/serverTimeOffset")).val()||0;return(new Date).getTime()+t}function ht(n){return aa({timestamp:zi(n)})}function $i(n,e,t,s,i){n.dataUpdateCount++;const r=new E(e);t=n.interceptServerDataCallback_?n.interceptServerDataCallback_(e,t):t;let o=[];if(i)if(s){const a=(0,c.UI)(t,h=>R(h));o=function na(n,e,t,s){const i=Bn(n,s);if(i){const r=Vn(i),o=r.path,l=r.queryId,a=M(o,e),h=b.fromObject(t);return Gn(n,o,new De(Nn(l),a,h))}return[]}(n.serverSyncTree_,r,a,i)}else{const a=R(t);o=Oi(n.serverSyncTree_,r,a,i)}else if(s){const a=(0,c.UI)(t,h=>R(h));o=function Zl(n,e,t){const s=b.fromObject(t);return Me(n,new De({fromUser:!1,fromServer:!0,queryId:null,tagged:!1},e,s))}(n.serverSyncTree_,r,a)}else{const a=R(t);o=nt(n.serverSyncTree_,r,a)}let l=r;o.length>0&&(l=Fe(n,r)),W(n.eventQueue_,l,o)}function qi(n,e){Jn(n,"connected",e),!1===e&&function Na(n){Le(n,"onDisconnectEvents");const e=ht(n),t=Rt();In(n.onDisconnect_,w(),(i,r)=>{const o=Ui(i,r,n.serverSyncTree_,e);Ae(t,i,o)});let s=[];In(t,w(),(i,r)=>{s=s.concat(nt(n.serverSyncTree_,i,r));const o=ns(n,i);Fe(n,o)}),n.onDisconnect_=Rt(),W(n.eventQueue_,w(),s)}(n)}function Jn(n,e,t){const s=new E("/.info/"+e),i=R(t);n.infoData_.updateSnapshot(s,i);const r=nt(n.infoSyncTree_,s,i);W(n.eventQueue_,s,r)}function Yt(n){return n.nextWriteId_++}function Zn(n,e,t,s,i){Le(n,"set",{path:e.toString(),value:t,priority:s});const r=ht(n),o=R(t,s),l=Bt(n.serverSyncTree_,e),a=Kn(o,l,r),h=Yt(n),u=Wn(n.serverSyncTree_,e,a,h,!0);Kt(n.eventQueue_,u),n.server_.put(e.toString(),o.val(!0),(f,_)=>{const p="ok"===f;p||O("set at "+e+" failed: "+f);const C=ae(n.serverSyncTree_,h,!p);W(n.eventQueue_,e,C),ce(0,i,f,_)});const d=ns(n,e);Fe(n,d),W(n.eventQueue_,d,[])}function Ra(n,e,t){n.server_.onDisconnectCancel(e.toString(),(s,i)=>{"ok"===s&&Tn(n.onDisconnect_,e),ce(0,t,s,i)})}function Xi(n,e,t,s){const i=R(t);n.server_.onDisconnectPut(e.toString(),i.val(!0),(r,o)=>{"ok"===r&&Ae(n.onDisconnect_,e,i),ce(0,s,r,o)})}function es(n,e,t){let s;s=".info"===m(e._path)?Ut(n.infoSyncTree_,e,t):Ut(n.serverSyncTree_,e,t),Ki(n.eventQueue_,e._path,s)}function Ji(n){n.persistentConnection_&&n.persistentConnection_.interrupt(ji)}function Le(n,...e){let t="";n.persistentConnection_&&(t=n.persistentConnection_.id+":"),x(t,...e)}function ce(n,e,t,s){e&&Ne(()=>{if("ok"===t)e(null);else{const i=(t||"error").toUpperCase();let r=i;s&&(r+=": "+s);const o=new Error(r);o.code=i,e(o)}})}function ts(n,e,t){return Bt(n.serverSyncTree_,e,t)||g.EMPTY_NODE}function jt(n,e=n.transactionQueueTree_){if(e||zt(n,e),Ee(e)){const t=er(n,e);(0,c.hu)(t.length>0,"Sending zero length transaction queue"),t.every(i=>0===i.status)&&function Oa(n,e,t){const s=t.map(h=>h.currentWriteId),i=ts(n,e,s);let r=i;const o=i.hash();for(let h=0;h<t.length;h++){const u=t[h];(0,c.hu)(0===u.status,"tryToSendTransactionQueue_: items in queue should all be run."),u.status=1,u.retryCount++;const d=M(e,u.path);r=r.updateChild(d,u.currentOutputSnapshotRaw)}const l=r.val(!0),a=e;n.server_.put(a.toString(),l,h=>{Le(n,"transaction put response",{path:a.toString(),status:h});let u=[];if("ok"===h){const d=[];for(let f=0;f<t.length;f++)t[f].status=2,u=u.concat(ae(n.serverSyncTree_,t[f].currentWriteId)),t[f].onComplete&&d.push(()=>t[f].onComplete(null,!0,t[f].currentOutputSnapshotResolved)),t[f].unwatcher();zt(n,Gt(n.transactionQueueTree_,e)),jt(n,n.transactionQueueTree_),W(n.eventQueue_,e,u);for(let f=0;f<d.length;f++)Ne(d[f])}else{if("datastale"===h)for(let d=0;d<t.length;d++)t[d].status=3===t[d].status?4:0;else{O("transaction at "+a.toString()+" failed: "+h);for(let d=0;d<t.length;d++)t[d].status=4,t[d].abortReason=h}Fe(n,e)}},o)}(n,rt(e),t)}else Bi(e)&&Ht(e,t=>{jt(n,t)})}function Fe(n,e){const t=Zi(n,e),s=rt(t);return function Ma(n,e,t){if(0===e.length)return;const s=[];let i=[];const o=e.filter(l=>0===l.status).map(l=>l.currentWriteId);for(let l=0;l<e.length;l++){const a=e[l],h=M(t,a.path);let d,u=!1;if((0,c.hu)(null!==h,"rerunTransactionsUnderNode_: relativePath should not be null."),4===a.status)u=!0,d=a.abortReason,i=i.concat(ae(n.serverSyncTree_,a.currentWriteId,!0));else if(0===a.status)if(a.retryCount>=wa)u=!0,d="maxretry",i=i.concat(ae(n.serverSyncTree_,a.currentWriteId,!0));else{const f=ts(n,a.path,o);a.currentInputSnapshot=f;const _=e[l].update(f.val());if(void 0!==_){lt("transaction failed: Data returned ",_,a.path);let p=R(_);"object"==typeof _&&null!=_&&(0,c.r3)(_,".priority")||(p=p.updatePriority(f.getPriority()));const A=a.currentWriteId,X=ht(n),ee=Kn(p,f,X);a.currentOutputSnapshotRaw=p,a.currentOutputSnapshotResolved=ee,a.currentWriteId=Yt(n),o.splice(o.indexOf(A),1),i=i.concat(Wn(n.serverSyncTree_,a.path,ee,a.currentWriteId,a.applyLocally)),i=i.concat(ae(n.serverSyncTree_,A,!0))}else u=!0,d="nodata",i=i.concat(ae(n.serverSyncTree_,a.currentWriteId,!0))}W(n.eventQueue_,t,i),i=[],u&&(e[l].status=2,setTimeout(e[l].unwatcher,Math.floor(0)),e[l].onComplete&&s.push("nodata"===d?()=>e[l].onComplete(null,!1,e[l].currentInputSnapshot):()=>e[l].onComplete(new Error(d),!1,null)))}zt(n,n.transactionQueueTree_);for(let l=0;l<s.length;l++)Ne(s[l]);jt(n,n.transactionQueueTree_)}(n,er(n,t),s),s}function Zi(n,e){let t,s=n.transactionQueueTree_;for(t=m(e);null!==t&&void 0===Ee(s);)s=Gt(s,t),t=m(e=I(e));return s}function er(n,e){const t=[];return tr(n,e,t),t.sort((s,i)=>s.order-i.order),t}function tr(n,e,t){const s=Ee(e);if(s)for(let i=0;i<s.length;i++)t.push(s[i]);Ht(e,i=>{tr(n,i,t)})}function zt(n,e){const t=Ee(e);if(t){let s=0;for(let i=0;i<t.length;i++)2!==t[i].status&&(t[s]=t[i],s++);t.length=s,zn(e,t.length>0?t:void 0)}Ht(e,s=>{zt(n,s)})}function ns(n,e){const t=rt(Zi(n,e)),s=Gt(n.transactionQueueTree_,e);return function da(n,e,t){let s=t?n:n.parent;for(;null!==s;){if(e(s))return!0;s=s.parent}}(s,i=>{ss(n,i)}),ss(n,s),Vi(s,i=>{ss(n,i)}),t}function ss(n,e){const t=Ee(e);if(t){const s=[];let i=[],r=-1;for(let o=0;o<t.length;o++)3===t[o].status||(1===t[o].status?((0,c.hu)(r===o-1,"All SENT items should be at beginning of queue."),r=o,t[o].status=3,t[o].abortReason="set"):((0,c.hu)(0===t[o].status,"Unexpected transaction status in abort"),t[o].unwatcher(),i=i.concat(ae(n.serverSyncTree_,t[o].currentWriteId,!0)),t[o].onComplete&&s.push(t[o].onComplete.bind(null,new Error("set"),!1,null))));-1===r?zn(e,void 0):t.length=r+1,W(n.eventQueue_,rt(e),i);for(let o=0;o<s.length;o++)Ne(s[o])}}const is=function(n,e){const t=Wa(n),s=t.namespace;return"firebase.com"===t.domain&&j(t.host+" is no longer supported. Please use <YOUR FIREBASE>.firebaseio.com instead"),(!s||"undefined"===s)&&"localhost"!==t.domain&&j("Cannot parse Firebase url. Please use https://<YOUR FIREBASE>.firebaseio.com"),t.secure||typeof window<"u"&&window.location&&window.location.protocol&&-1!==window.location.protocol.indexOf("https:")&&O("Insecure Firebase access from a secure page. Please use https in calls to new Firebase()."),{repoInfo:new on(t.host,t.secure,s,"ws"===t.scheme||"wss"===t.scheme,e,"",s!==t.subdomain),path:new E(t.pathString)}},Wa=function(n){let e="",t="",s="",i="",r="",o=!0,l="https",a=443;if("string"==typeof n){let h=n.indexOf("//");h>=0&&(l=n.substring(0,h-1),n=n.substring(h+2));let u=n.indexOf("/");-1===u&&(u=n.length);let d=n.indexOf("?");-1===d&&(d=n.length),e=n.substring(0,Math.min(u,d)),u<d&&(i=function La(n){let e="";const t=n.split("/");for(let s=0;s<t.length;s++)if(t[s].length>0){let i=t[s];try{i=decodeURIComponent(i.replace(/\+/g," "))}catch{}e+="/"+i}return e}(n.substring(u,d)));const f=function Fa(n){const e={};"?"===n.charAt(0)&&(n=n.substring(1));for(const t of n.split("&")){if(0===t.length)continue;const s=t.split("=");2===s.length?e[decodeURIComponent(s[0])]=decodeURIComponent(s[1]):O(`Invalid query segment '${t}' in query '${n}'`)}return e}(n.substring(Math.min(n.length,d)));h=e.indexOf(":"),h>=0?(o="https"===l||"wss"===l,a=parseInt(e.substring(h+1),10)):h=e.length;const _=e.slice(0,h);if("localhost"===_.toLowerCase())t="localhost";else if(_.split(".").length<=2)t=_;else{const p=e.indexOf(".");s=e.substring(0,p).toLowerCase(),t=e.substring(p+1),r=s}"ns"in f&&(r=f.ns)}return{host:e,port:a,domain:t,subdomain:s,secure:o,scheme:l,pathString:i,namespace:r}},nr="-0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz",Ua=function(){let n=0;const e=[];return function(t){const s=t===n;let i;n=t;const r=new Array(8);for(i=7;i>=0;i--)r[i]=nr.charAt(t%64),t=Math.floor(t/64);(0,c.hu)(0===t,"Cannot push at time == 0");let o=r.join("");if(s){for(i=11;i>=0&&63===e[i];i--)e[i]=0;e[i]++}else for(i=0;i<12;i++)e[i]=Math.floor(64*Math.random());for(i=0;i<12;i++)o+=nr.charAt(e[i]);return(0,c.hu)(20===o.length,"nextPushId: Length should be 20."),o}}();class sr{constructor(e,t,s,i){this.eventType=e,this.eventRegistration=t,this.snapshot=s,this.prevName=i}getPath(){const e=this.snapshot.ref;return"value"===this.eventType?e._path:e.parent._path}getEventType(){return this.eventType}getEventRunner(){return this.eventRegistration.getEventRunner(this)}toString(){return this.getPath().toString()+":"+this.eventType+":"+(0,c.Wl)(this.snapshot.exportVal())}}class ir{constructor(e,t,s){this.eventRegistration=e,this.error=t,this.path=s}getPath(){return this.path}getEventType(){return"cancel"}getEventRunner(){return this.eventRegistration.getEventRunner(this)}toString(){return this.path.toString()+":cancel"}}class rs{constructor(e,t){this.snapshotCallback=e,this.cancelCallback=t}onValue(e,t){this.snapshotCallback.call(null,e,t)}onCancel(e){return(0,c.hu)(this.hasCancelCallback,"Raising a cancel event on a listener with no cancel callback"),this.cancelCallback.call(null,e)}get hasCancelCallback(){return!!this.cancelCallback}matches(e){return this.snapshotCallback===e.snapshotCallback||void 0!==this.snapshotCallback.userCallback&&this.snapshotCallback.userCallback===e.snapshotCallback.userCallback&&this.snapshotCallback.context===e.snapshotCallback.context}}class rr{constructor(e,t){this._repo=e,this._path=t}cancel(){const e=new c.BH;return Ra(this._repo,this._path,e.wrapCallback(()=>{})),e.promise}remove(){V("OnDisconnect.remove",this._path);const e=new c.BH;return Xi(this._repo,this._path,null,e.wrapCallback(()=>{})),e.promise}set(e){V("OnDisconnect.set",this._path),q("OnDisconnect.set",e,this._path,!1);const t=new c.BH;return Xi(this._repo,this._path,e,t.wrapCallback(()=>{})),t.promise}setWithPriority(e,t){V("OnDisconnect.setWithPriority",this._path),q("OnDisconnect.setWithPriority",e,this._path,!1),Xn("OnDisconnect.setWithPriority",t,!1);const s=new c.BH;return function Pa(n,e,t,s,i){const r=R(t,s);n.server_.onDisconnectPut(e.toString(),r.val(!0),(o,l)=>{"ok"===o&&Ae(n.onDisconnect_,e,r),ce(0,i,o,l)})}(this._repo,this._path,e,t,s.wrapCallback(()=>{})),s.promise}update(e){V("OnDisconnect.update",this._path),Hi("OnDisconnect.update",e,this._path,!1);const t=new c.BH;return function xa(n,e,t,s){if((0,c.xb)(t))return x("onDisconnect().update() called with empty data.  Don't do anything."),void ce(0,s,"ok",void 0);n.server_.onDisconnectMerge(e.toString(),t,(i,r)=>{"ok"===i&&k(t,(o,l)=>{const a=R(l);Ae(n.onDisconnect_,N(e,o),a)}),ce(0,s,i,r)})}(this._repo,this._path,e,t.wrapCallback(()=>{})),t.promise}}class F{constructor(e,t,s,i){this._repo=e,this._path=t,this._queryParams=s,this._orderByCalled=i}get key(){return y(this._path)?null:dn(this._path)}get ref(){return new G(this._repo,this._path)}get _queryIdentifier(){const e=ci(this._queryParams),t=sn(e);return"{}"===t?"default":t}get _queryObject(){return ci(this._queryParams)}isEqual(e){if(!((e=(0,c.m9)(e))instanceof F))return!1;const t=this._repo===e._repo,s=fn(this._path,e._path);return t&&s&&this._queryIdentifier===e._queryIdentifier}toJSON(){return this.toString()}toString(){return this._repo.toString()+function xo(n){let e="";for(let t=n.pieceNum_;t<n.pieces_.length;t++)""!==n.pieces_[t]&&(e+="/"+encodeURIComponent(String(n.pieces_[t])));return e||"/"}(this._path)}}function $t(n,e){if(!0===n._orderByCalled)throw new Error(e+": You can't combine multiple orderBy calls.")}function he(n){let e=null,t=null;if(n.hasStart()&&(e=n.getIndexStartValue()),n.hasEnd()&&(t=n.getIndexEndValue()),n.getIndex()===z){const s="Query: When ordering by key, you may only pass one argument to startAt(), endAt(), or equalTo().",i="Query: When ordering by key, the argument passed to startAt(), startAfter(), endAt(), endBefore(), or equalTo() must be a string.";if(n.hasStart()){if(n.getIndexStartName()!==te)throw new Error(s);if("string"!=typeof e)throw new Error(i)}if(n.hasEnd()){if(n.getIndexEndName()!==J)throw new Error(s);if("string"!=typeof t)throw new Error(i)}}else if(n.getIndex()===S){if(null!=e&&!ot(e)||null!=t&&!ot(t))throw new Error("Query: When ordering by priority, the first argument passed to startAt(), startAfter() endAt(), endBefore(), or equalTo() must be a valid priority value (null, a number, or a string).")}else if((0,c.hu)(n.getIndex()instanceof yn||n.getIndex()===vn,"unknown index type."),null!=e&&"object"==typeof e||null!=t&&"object"==typeof t)throw new Error("Query: First argument passed to startAt(), startAfter(), endAt(), endBefore(), or equalTo() cannot be an object.")}function qt(n){if(n.hasStart()&&n.hasEnd()&&n.hasLimit()&&!n.hasAnchoredLimit())throw new Error("Query: Can't combine startAt(), startAfter(), endAt(), endBefore(), and limit(). Use limitToFirst() or limitToLast() instead.")}class G extends F{constructor(e,t){super(e,t,new St,!1)}get parent(){const e=Xs(this._path);return null===e?null:new G(this._repo,e)}get root(){let e=this;for(;null!==e.parent;)e=e.parent;return e}}class Te{constructor(e,t,s){this._node=e,this.ref=t,this._index=s}get priority(){return this._node.getPriority().val()}get key(){return this.ref.key}get size(){return this._node.numChildren()}child(e){const t=new E(e),s=Ie(this.ref,e);return new Te(this._node.getChild(t),s,S)}exists(){return!this._node.isEmpty()}exportVal(){return this._node.val(!0)}forEach(e){return!this._node.isLeafNode()&&!!this._node.forEachChild(this._index,(s,i)=>e(new Te(i,Ie(this.ref,s),S)))}hasChild(e){const t=new E(e);return!this._node.getChild(t).isEmpty()}hasChildren(){return!this._node.isLeafNode()&&!this._node.isEmpty()}toJSON(){return this.exportVal()}val(){return this._node.val()}}function or(n,e){return(n=(0,c.m9)(n))._checkNotDeleted("ref"),void 0!==e?Ie(n._root,e):n._root}function lr(n,e){(n=(0,c.m9)(n))._checkNotDeleted("refFromURL");const t=is(e,n._repo.repoInfo_.nodeAdmin);Qi("refFromURL",t);const s=t.repoInfo;return!n._repo.repoInfo_.isCustomHost()&&s.host!==n._repo.repoInfo_.host&&j("refFromURL: Host name does not match the current database: (found "+s.host+" but expected "+n._repo.repoInfo_.host+")"),or(n,t.path.toString())}function Ie(n,e){return null===m((n=(0,c.m9)(n))._path)?ya("child","path",e,!1):ct("child","path",e,!1),new G(n._repo,N(n._path,e))}function os(n,e){n=(0,c.m9)(n),V("set",n._path),q("set",e,n._path,!1);const t=new c.BH;return Zn(n._repo,n._path,e,null,t.wrapCallback(()=>{})),t.promise}function Qa(n,e){Hi("update",e,n._path,!1);const t=new c.BH;return function ba(n,e,t,s){Le(n,"update",{path:e.toString(),value:t});let i=!0;const r=ht(n),o={};if(k(t,(l,a)=>{i=!1,o[l]=Ui(N(e,l),R(a),n.serverSyncTree_,r)}),i)x("update() called with empty data.  Don't do anything."),ce(0,s,"ok",void 0);else{const l=Yt(n),a=function Jl(n,e,t,s){!function pl(n,e,t,s){(0,c.hu)(s>n.lastWriteId,"Stacking an older merge on top of newer ones"),n.allWrites.push({path:e,children:t,writeId:s,visible:!0}),n.visibleWrites=Pn(n.visibleWrites,e,t),n.lastWriteId=s}(n.pendingWriteTree_,e,t,s);const i=b.fromObject(t);return Me(n,new De({fromUser:!0,fromServer:!1,queryId:null,tagged:!1},e,i))}(n.serverSyncTree_,e,o,l);Kt(n.eventQueue_,a),n.server_.merge(e.toString(),t,(h,u)=>{const d="ok"===h;d||O("update at "+e+" failed: "+h);const f=ae(n.serverSyncTree_,l,!d),_=f.length>0?Fe(n,e):e;W(n.eventQueue_,_,f),ce(0,s,h,u)}),k(t,h=>{const u=ns(n,N(e,h));Fe(n,u)}),W(n.eventQueue_,e,[])}}(n._repo,n._path,e,t.wrapCallback(()=>{})),t.promise}function Ka(n){n=(0,c.m9)(n);const e=new rs(()=>{}),t=new ut(e);return function Sa(n,e,t){const s=function sa(n,e){const t=e._path;let s=null;n.syncPointTree_.foreachOnPath(t,(h,u)=>{const d=M(h,t);s=s||oe(u,d)});let i=n.syncPointTree_.get(t);i?s=s||oe(i,w()):(i=new Ri,n.syncPointTree_=n.syncPointTree_.set(t,i));const r=null!=s,o=r?new ie(s,!0,!1):null;return function Bl(n){return kt(n.viewCache_)}(Pi(i,e,At(n.pendingWriteTree_,e._path),r?o.getNode():g.EMPTY_NODE,r))}(n.serverSyncTree_,e);return null!=s?Promise.resolve(s):n.server_.get(e).then(i=>{const r=R(i).withIndex(e._queryParams.getIndex());let o;if(Un(n.serverSyncTree_,e,t,!0),e._queryParams.loadsAllData())o=nt(n.serverSyncTree_,e._path,r);else{const l=st(n.serverSyncTree_,e);o=Oi(n.serverSyncTree_,e._path,r,l)}return W(n.eventQueue_,e._path,o),Ut(n.serverSyncTree_,e,t,null,!0),r},i=>(Le(n,"get for query "+(0,c.Wl)(e)+" failed: "+i),Promise.reject(new Error(i))))}(n._repo,n,t).then(s=>new Te(s,new G(n._repo,n._path),n._queryParams.getIndex()))}class ut{constructor(e){this.callbackContext=e}respondsTo(e){return"value"===e}createEvent(e,t){const s=t._queryParams.getIndex();return new sr("value",this,new Te(e.snapshotNode,new G(t._repo,t._path),s))}getEventRunner(e){return"cancel"===e.getEventType()?()=>this.callbackContext.onCancel(e.error):()=>this.callbackContext.onValue(e.snapshot,null)}createCancelEvent(e,t){return this.callbackContext.hasCancelCallback?new ir(this,e,t):null}matches(e){return e instanceof ut&&(!e.callbackContext||!this.callbackContext||e.callbackContext.matches(this.callbackContext))}hasAnyCallback(){return null!==this.callbackContext}}class Xt{constructor(e,t){this.eventType=e,this.callbackContext=t}respondsTo(e){let t="children_added"===e?"child_added":e;return t="children_removed"===t?"child_removed":t,this.eventType===t}createCancelEvent(e,t){return this.callbackContext.hasCancelCallback?new ir(this,e,t):null}createEvent(e,t){(0,c.hu)(null!=e.childName,"Child events should have a childName.");const s=Ie(new G(t._repo,t._path),e.childName),i=t._queryParams.getIndex();return new sr(e.type,this,new Te(e.snapshotNode,s,i),e.prevName)}getEventRunner(e){return"cancel"===e.getEventType()?()=>this.callbackContext.onCancel(e.error):()=>this.callbackContext.onValue(e.snapshot,e.prevName)}matches(e){return e instanceof Xt&&this.eventType===e.eventType&&(!this.callbackContext||!e.callbackContext||this.callbackContext.matches(e.callbackContext))}hasAnyCallback(){return!!this.callbackContext}}function dt(n,e,t,s,i){let r;if("object"==typeof s&&(r=void 0,i=s),"function"==typeof s&&(r=s),i&&i.onlyOnce){const a=t,h=(u,d)=>{es(n._repo,n,l),a(u,d)};h.userCallback=t.userCallback,h.context=t.context,t=h}const o=new rs(t,r||void 0),l="value"===e?new ut(o):new Xt(e,o);return function ka(n,e,t){let s;s=".info"===m(e._path)?Un(n.infoSyncTree_,e,t):Un(n.serverSyncTree_,e,t),Ki(n.eventQueue_,e._path,s)}(n._repo,n,l),()=>es(n._repo,n,l)}function ls(n,e,t,s){return dt(n,"value",e,t,s)}function ar(n,e,t,s){return dt(n,"child_added",e,t,s)}function cr(n,e,t,s){return dt(n,"child_changed",e,t,s)}function hr(n,e,t,s){return dt(n,"child_moved",e,t,s)}function ur(n,e,t,s){return dt(n,"child_removed",e,t,s)}function dr(n,e,t){let s=null;const i=t?new rs(t):null;"value"===e?s=new ut(i):e&&(s=new Xt(e,i)),es(n._repo,n,s)}class K{}class fr extends K{constructor(e,t){super(),this._value=e,this._key=t}_apply(e){q("endAt",this._value,e._path,!0);const t=En(e._queryParams,this._value,this._key);if(qt(t),he(t),e._queryParams.hasEnd())throw new Error("endAt: Starting point was already set (by another call to endAt, endBefore or equalTo).");return new F(e._repo,e._path,t,e._orderByCalled)}}class ja extends K{constructor(e,t){super(),this._value=e,this._key=t}_apply(e){q("endBefore",this._value,e._path,!1);const t=function nl(n,e,t){let s;return s=En(n,e,n.index_===z||t?t:te),s.endBeforeSet_=!0,s}(e._queryParams,this._value,this._key);if(qt(t),he(t),e._queryParams.hasEnd())throw new Error("endBefore: Starting point was already set (by another call to endAt, endBefore or equalTo).");return new F(e._repo,e._path,t,e._orderByCalled)}}class _r extends K{constructor(e,t){super(),this._value=e,this._key=t}_apply(e){q("startAt",this._value,e._path,!0);const t=wn(e._queryParams,this._value,this._key);if(qt(t),he(t),e._queryParams.hasStart())throw new Error("startAt: Starting point was already set (by another call to startAt, startBefore or equalTo).");return new F(e._repo,e._path,t,e._orderByCalled)}}class qa extends K{constructor(e,t){super(),this._value=e,this._key=t}_apply(e){q("startAfter",this._value,e._path,!1);const t=function tl(n,e,t){let s;return s=wn(n,e,n.index_===z||t?t:J),s.startAfterSet_=!0,s}(e._queryParams,this._value,this._key);if(qt(t),he(t),e._queryParams.hasStart())throw new Error("startAfter: Starting point was already set (by another call to startAt, startAfter, or equalTo).");return new F(e._repo,e._path,t,e._orderByCalled)}}class Ja extends K{constructor(e){super(),this._limit=e}_apply(e){if(e._queryParams.hasLimit())throw new Error("limitToFirst: Limit was already set (by another call to limitToFirst or limitToLast).");return new F(e._repo,e._path,function Zo(n,e){const t=n.copy();return t.limitSet_=!0,t.limit_=e,t.viewFrom_="l",t}(e._queryParams,this._limit),e._orderByCalled)}}class ec extends K{constructor(e){super(),this._limit=e}_apply(e){if(e._queryParams.hasLimit())throw new Error("limitToLast: Limit was already set (by another call to limitToFirst or limitToLast).");return new F(e._repo,e._path,function el(n,e){const t=n.copy();return t.limitSet_=!0,t.limit_=e,t.viewFrom_="r",t}(e._queryParams,this._limit),e._orderByCalled)}}class nc extends K{constructor(e){super(),this._path=e}_apply(e){$t(e,"orderByChild");const t=new E(this._path);if(y(t))throw new Error("orderByChild: cannot pass in empty path. Use orderByValue() instead.");const s=new yn(t),i=bt(e._queryParams,s);return he(i),new F(e._repo,e._path,i,!0)}}class ic extends K{_apply(e){$t(e,"orderByKey");const t=bt(e._queryParams,z);return he(t),new F(e._repo,e._path,t,!0)}}class oc extends K{_apply(e){$t(e,"orderByPriority");const t=bt(e._queryParams,S);return he(t),new F(e._repo,e._path,t,!0)}}class ac extends K{_apply(e){$t(e,"orderByValue");const t=bt(e._queryParams,vn);return he(t),new F(e._repo,e._path,t,!0)}}class hc extends K{constructor(e,t){super(),this._value=e,this._key=t}_apply(e){if(q("equalTo",this._value,e._path,!1),e._queryParams.hasStart())throw new Error("equalTo: Starting point was already set (by another call to startAt/startAfter or equalTo).");if(e._queryParams.hasEnd())throw new Error("equalTo: Ending point was already set (by another call to endAt/endBefore or equalTo).");return new fr(this._value,this._key)._apply(new _r(this._value,this._key)._apply(e))}}function Y(n,...e){let t=(0,c.m9)(n);for(const s of e)t=s._apply(t);return t}(function Ql(n){(0,c.hu)(!Lt,"__referenceConstructor has already been defined"),Lt=n})(G),function $l(n){(0,c.hu)(!Wt,"__referenceConstructor has already been defined"),Wt=n}(G);const as={};function gr(n,e,t,s,i){let r=s||n.options.databaseURL;void 0===r&&(n.options.projectId||j("Can't determine Firebase Database URL. Be sure to include  a Project ID when calling firebase.initializeApp()."),x("Using default host for project ",n.options.projectId),r=`${n.options.projectId}-default-rtdb.firebaseio.com`);let a,h,o=is(r,i),l=o.repoInfo;typeof process<"u"&&process.env&&(h=process.env.FIREBASE_DATABASE_EMULATOR_HOST),h?(a=!0,r=`http://${h}?ns=${l.namespace}`,o=is(r,i),l=o.repoInfo):a=!o.repoInfo.secure;const u=i&&a?new Qe(Qe.OWNER):new io(n.name,n.options,e);Qi("Invalid Firebase Database URL",o),y(o.path)||j("Database URL must point to the root of a Firebase Database (not including a child path).");const d=function pc(n,e,t,s){let i=as[e.name];i||(i={},as[e.name]=i);let r=i[n.toURLString()];return r&&j("Database initialized multiple times. Please make sure the format of the database URL matches with each database() call."),r=new Ea(n,false,t,s),i[n.toURLString()]=r,r}(l,n,u,new so(n.name,t));return new mc(d,n)}class mc{constructor(e,t){this._repoInternal=e,this.app=t,this.type="database",this._instanceStarted=!1}get _repo(){return this._instanceStarted||(function Ta(n,e,t){if(n.stats_=cn(n.repoInfo_),n.forceRestClient_||("object"==typeof window&&window.navigator&&window.navigator.userAgent||"").search(/googlebot|google webmaster tools|bingbot|yahoo! slurp|baiduspider|yandexbot|duckduckbot/i)>=0)n.server_=new Nt(n.repoInfo_,(s,i,r,o)=>{$i(n,s,i,r,o)},n.authTokenProvider_,n.appCheckProvider_),setTimeout(()=>qi(n,!0),0);else{if(typeof t<"u"&&null!==t){if("object"!=typeof t)throw new Error("Only objects are supported for option databaseAuthVariableOverride");try{(0,c.Wl)(t)}catch(s){throw new Error("Invalid authOverride provided: "+s)}}n.persistentConnection_=new ye(n.repoInfo_,e,(s,i,r,o)=>{$i(n,s,i,r,o)},s=>{qi(n,s)},s=>{!function Ia(n,e){k(e,(t,s)=>{Jn(n,t,s)})}(n,s)},n.authTokenProvider_,n.appCheckProvider_,t),n.server_=n.persistentConnection_}n.authTokenProvider_.addTokenChangeListener(s=>{n.server_.refreshAuthToken(s)}),n.appCheckProvider_.addTokenChangeListener(s=>{n.server_.refreshAppCheckToken(s.token)}),n.statsReporter_=function lo(n,e){const t=n.toString();return an[t]||(an[t]=e()),an[t]}(n.repoInfo_,()=>new al(n.stats_,n.server_)),n.infoData_=new sl,n.infoSyncTree_=new Di({startListening:(s,i,r,o)=>{let l=[];const a=n.infoData_.getNode(s._path);return a.isEmpty()||(l=nt(n.infoSyncTree_,s._path,a),setTimeout(()=>{o("ok")},0)),l},stopListening:()=>{}}),Jn(n,"connected",!1),n.serverSyncTree_=new Di({startListening:(s,i,r,o)=>(n.server_.listen(s,r,i,(l,a)=>{const h=o(l,a);W(n.eventQueue_,s._path,h)}),[]),stopListening:(s,i)=>{n.server_.unlisten(s,i)}})}(this._repoInternal,this.app.options.appId,this.app.options.databaseAuthVariableOverride),this._instanceStarted=!0),this._repoInternal}get _root(){return this._rootInternal||(this._rootInternal=new G(this._repo,w())),this._rootInternal}_delete(){return null!==this._rootInternal&&(function _c(n,e){const t=as[e];(!t||t[n.key]!==n)&&j(`Database ${e}(${n.repoInfo_}) has already been deleted.`),Ji(n),delete t[n.key]}(this._repo,this.app.name),this._repoInternal=null,this._rootInternal=null),Promise.resolve()}_checkNotDeleted(e){null===this._rootInternal&&j("Cannot call "+e+" on a deleted database.")}}function mr(){Us.IS_TRANSPORT_INITIALIZED&&O("Transport has already been initialized. Please call this function before calling ref or setting up a listener")}function yc(){mr(),ne.forceDisallow()}function vc(){mr(),Re.forceDisallow(),ne.forceAllow()}function Ec(n,e){vs(n,e)}const Ic={".sv":"timestamp"};class Nc{constructor(e,t){this.committed=e,this.snapshot=t}toJSON(){return{committed:this.committed,snapshot:this.snapshot.toJSON()}}}ye.prototype.simpleListen=function(n,e){this.sendRequest("q",{p:n},e)},ye.prototype.echo=function(n,e){this.sendRequest("echo",{d:n},e)},function Tc(n){_s(gt.SDK_VERSION),(0,gt._registerComponent)(new Ue.wA("database",(e,{instanceIdentifier:t})=>gr(e.getProvider("app").getImmediate(),e.getProvider("auth-internal"),e.getProvider("app-check-internal"),t),"PUBLIC").setMultipleInstances(!0)),(0,gt.registerVersion)(ds,"0.14.4",n),(0,gt.registerVersion)(ds,"0.14.4","esm2017")}();const kc=new Zt.Yd("@firebase/database-compat"),vr=function(n){kc.warn("FIREBASE WARNING: "+n)};class Oc{constructor(e){this._delegate=e}cancel(e){(0,c.Dv)("OnDisconnect.cancel",0,1,arguments.length),(0,c.Wj)("OnDisconnect.cancel","onComplete",e,!0);const t=this._delegate.cancel();return e&&t.then(()=>e(null),s=>e(s)),t}remove(e){(0,c.Dv)("OnDisconnect.remove",0,1,arguments.length),(0,c.Wj)("OnDisconnect.remove","onComplete",e,!0);const t=this._delegate.remove();return e&&t.then(()=>e(null),s=>e(s)),t}set(e,t){(0,c.Dv)("OnDisconnect.set",1,2,arguments.length),(0,c.Wj)("OnDisconnect.set","onComplete",t,!0);const s=this._delegate.set(e);return t&&s.then(()=>t(null),i=>t(i)),s}setWithPriority(e,t,s){(0,c.Dv)("OnDisconnect.setWithPriority",2,3,arguments.length),(0,c.Wj)("OnDisconnect.setWithPriority","onComplete",s,!0);const i=this._delegate.setWithPriority(e,t);return s&&i.then(()=>s(null),r=>s(r)),i}update(e,t){if((0,c.Dv)("OnDisconnect.update",1,2,arguments.length),Array.isArray(e)){const i={};for(let r=0;r<e.length;++r)i[""+r]=e[r];e=i,vr("Passing an Array to firebase.database.onDisconnect().update() is deprecated. Use set() if you want to overwrite the existing data, or an Object with integer keys if you really do want to only update some of the children.")}(0,c.Wj)("OnDisconnect.update","onComplete",t,!0);const s=this._delegate.update(e);return t&&s.then(()=>t(null),i=>t(i)),s}}class Mc{constructor(e,t){this.committed=e,this.snapshot=t}toJSON(){return(0,c.Dv)("TransactionResult.toJSON",0,1,arguments.length),{committed:this.committed,snapshot:this.snapshot.toJSON()}}}class ue{constructor(e,t){this._database=e,this._delegate=t}val(){return(0,c.Dv)("DataSnapshot.val",0,0,arguments.length),this._delegate.val()}exportVal(){return(0,c.Dv)("DataSnapshot.exportVal",0,0,arguments.length),this._delegate.exportVal()}toJSON(){return(0,c.Dv)("DataSnapshot.toJSON",0,1,arguments.length),this._delegate.toJSON()}exists(){return(0,c.Dv)("DataSnapshot.exists",0,0,arguments.length),this._delegate.exists()}child(e){return(0,c.Dv)("DataSnapshot.child",0,1,arguments.length),e=String(e),ct("DataSnapshot.child","path",e,!1),new ue(this._database,this._delegate.child(e))}hasChild(e){return(0,c.Dv)("DataSnapshot.hasChild",1,1,arguments.length),ct("DataSnapshot.hasChild","path",e,!1),this._delegate.hasChild(e)}getPriority(){return(0,c.Dv)("DataSnapshot.getPriority",0,0,arguments.length),this._delegate.priority}forEach(e){return(0,c.Dv)("DataSnapshot.forEach",1,1,arguments.length),(0,c.Wj)("DataSnapshot.forEach","action",e,!1),this._delegate.forEach(t=>e(new ue(this._database,t)))}hasChildren(){return(0,c.Dv)("DataSnapshot.hasChildren",0,0,arguments.length),this._delegate.hasChildren()}get key(){return this._delegate.key}numChildren(){return(0,c.Dv)("DataSnapshot.numChildren",0,0,arguments.length),this._delegate.size}getRef(){return(0,c.Dv)("DataSnapshot.ref",0,0,arguments.length),new U(this._database,this._delegate.ref)}get ref(){return this.getRef()}}class D{constructor(e,t){this.database=e,this._delegate=t}on(e,t,s,i){var r;(0,c.Dv)("Query.on",2,4,arguments.length),(0,c.Wj)("Query.on","callback",t,!1);const o=D.getCancelAndContextArgs_("Query.on",s,i),l=(h,u)=>{t.call(o.context,new ue(this.database,h),u)};l.userCallback=t,l.context=o.context;const a=null===(r=o.cancel)||void 0===r?void 0:r.bind(o.context);switch(e){case"value":return ls(this._delegate,l,a),t;case"child_added":return ar(this._delegate,l,a),t;case"child_removed":return ur(this._delegate,l,a),t;case"child_changed":return cr(this._delegate,l,a),t;case"child_moved":return hr(this._delegate,l,a),t;default:throw new Error((0,c.gK)("Query.on","eventType")+'must be a valid event type = "value", "child_added", "child_removed", "child_changed", or "child_moved".')}}off(e,t,s){if((0,c.Dv)("Query.off",0,3,arguments.length),function(n,e,t){if(void 0!==e)switch(e){case"value":case"child_added":case"child_removed":case"child_changed":case"child_moved":break;default:throw new Error((0,c.gK)("Query.off","eventType")+'must be a valid event type = "value", "child_added", "child_removed", "child_changed", or "child_moved".')}}(0,e),(0,c.Wj)("Query.off","callback",t,!0),(0,c.lb)("Query.off","context",s,!0),t){const i=()=>{};i.userCallback=t,i.context=s,dr(this._delegate,e,i)}else dr(this._delegate,e)}get(){return Ka(this._delegate).then(e=>new ue(this.database,e))}once(e,t,s,i){(0,c.Dv)("Query.once",1,4,arguments.length),(0,c.Wj)("Query.once","callback",t,!0);const r=D.getCancelAndContextArgs_("Query.once",s,i),o=new c.BH,l=(h,u)=>{const d=new ue(this.database,h);t&&t.call(r.context,d,u),o.resolve(d)};l.userCallback=t,l.context=r.context;const a=h=>{r.cancel&&r.cancel.call(r.context,h),o.reject(h)};switch(e){case"value":ls(this._delegate,l,a,{onlyOnce:!0});break;case"child_added":ar(this._delegate,l,a,{onlyOnce:!0});break;case"child_removed":ur(this._delegate,l,a,{onlyOnce:!0});break;case"child_changed":cr(this._delegate,l,a,{onlyOnce:!0});break;case"child_moved":hr(this._delegate,l,a,{onlyOnce:!0});break;default:throw new Error((0,c.gK)("Query.once","eventType")+'must be a valid event type = "value", "child_added", "child_removed", "child_changed", or "child_moved".')}return o.promise}limitToFirst(e){return(0,c.Dv)("Query.limitToFirst",1,1,arguments.length),new D(this.database,Y(this._delegate,function Za(n){if("number"!=typeof n||Math.floor(n)!==n||n<=0)throw new Error("limitToFirst: First argument must be a positive integer.");return new Ja(n)}(e)))}limitToLast(e){return(0,c.Dv)("Query.limitToLast",1,1,arguments.length),new D(this.database,Y(this._delegate,function tc(n){if("number"!=typeof n||Math.floor(n)!==n||n<=0)throw new Error("limitToLast: First argument must be a positive integer.");return new ec(n)}(e)))}orderByChild(e){return(0,c.Dv)("Query.orderByChild",1,1,arguments.length),new D(this.database,Y(this._delegate,function sc(n){if("$key"===n)throw new Error('orderByChild: "$key" is invalid.  Use orderByKey() instead.');if("$priority"===n)throw new Error('orderByChild: "$priority" is invalid.  Use orderByPriority() instead.');if("$value"===n)throw new Error('orderByChild: "$value" is invalid.  Use orderByValue() instead.');return ct("orderByChild","path",n,!1),new nc(n)}(e)))}orderByKey(){return(0,c.Dv)("Query.orderByKey",0,0,arguments.length),new D(this.database,Y(this._delegate,function rc(){return new ic}()))}orderByPriority(){return(0,c.Dv)("Query.orderByPriority",0,0,arguments.length),new D(this.database,Y(this._delegate,function lc(){return new oc}()))}orderByValue(){return(0,c.Dv)("Query.orderByValue",0,0,arguments.length),new D(this.database,Y(this._delegate,function cc(){return new ac}()))}startAt(e=null,t){return(0,c.Dv)("Query.startAt",0,2,arguments.length),new D(this.database,Y(this._delegate,function $a(n=null,e){return at("startAt","key",e,!0),new _r(n,e)}(e,t)))}startAfter(e=null,t){return(0,c.Dv)("Query.startAfter",0,2,arguments.length),new D(this.database,Y(this._delegate,function Xa(n,e){return at("startAfter","key",e,!0),new qa(n,e)}(e,t)))}endAt(e=null,t){return(0,c.Dv)("Query.endAt",0,2,arguments.length),new D(this.database,Y(this._delegate,function Ya(n,e){return at("endAt","key",e,!0),new fr(n,e)}(e,t)))}endBefore(e=null,t){return(0,c.Dv)("Query.endBefore",0,2,arguments.length),new D(this.database,Y(this._delegate,function za(n,e){return at("endBefore","key",e,!0),new ja(n,e)}(e,t)))}equalTo(e,t){return(0,c.Dv)("Query.equalTo",1,2,arguments.length),new D(this.database,Y(this._delegate,function uc(n,e){return at("equalTo","key",e,!0),new hc(n,e)}(e,t)))}toString(){return(0,c.Dv)("Query.toString",0,0,arguments.length),this._delegate.toString()}toJSON(){return(0,c.Dv)("Query.toJSON",0,1,arguments.length),this._delegate.toJSON()}isEqual(e){if((0,c.Dv)("Query.isEqual",1,1,arguments.length),!(e instanceof D))throw new Error("Query.isEqual failed: First argument must be an instance of firebase.database.Query.");return this._delegate.isEqual(e._delegate)}static getCancelAndContextArgs_(e,t,s){const i={cancel:void 0,context:void 0};if(t&&s)i.cancel=t,(0,c.Wj)(e,"cancel",i.cancel,!0),i.context=s,(0,c.lb)(e,"context",i.context,!0);else if(t)if("object"==typeof t&&null!==t)i.context=t;else{if("function"!=typeof t)throw new Error((0,c.gK)(e,"cancelOrContext")+" must either be a cancel callback or a context object.");i.cancel=t}return i}get ref(){return new U(this.database,new G(this._delegate._repo,this._delegate._path))}}class U extends D{constructor(e,t){super(e,new F(t._repo,t._path,new St,!1)),this.database=e,this._delegate=t}getKey(){return(0,c.Dv)("Reference.key",0,0,arguments.length),this._delegate.key}child(e){return(0,c.Dv)("Reference.child",1,1,arguments.length),"number"==typeof e&&(e=String(e)),new U(this.database,Ie(this._delegate,e))}getParent(){(0,c.Dv)("Reference.parent",0,0,arguments.length);const e=this._delegate.parent;return e?new U(this.database,e):null}getRoot(){return(0,c.Dv)("Reference.root",0,0,arguments.length),new U(this.database,this._delegate.root)}set(e,t){(0,c.Dv)("Reference.set",1,2,arguments.length),(0,c.Wj)("Reference.set","onComplete",t,!0);const s=os(this._delegate,e);return t&&s.then(()=>t(null),i=>t(i)),s}update(e,t){if((0,c.Dv)("Reference.update",1,2,arguments.length),Array.isArray(e)){const i={};for(let r=0;r<e.length;++r)i[""+r]=e[r];e=i,vr("Passing an Array to Firebase.update() is deprecated. Use set() if you want to overwrite the existing data, or an Object with integer keys if you really do want to only update some of the children.")}V("Reference.update",this._delegate._path),(0,c.Wj)("Reference.update","onComplete",t,!0);const s=Qa(this._delegate,e);return t&&s.then(()=>t(null),i=>t(i)),s}setWithPriority(e,t,s){(0,c.Dv)("Reference.setWithPriority",2,3,arguments.length),(0,c.Wj)("Reference.setWithPriority","onComplete",s,!0);const i=function Ha(n,e,t){if(V("setWithPriority",n._path),q("setWithPriority",e,n._path,!1),Xn("setWithPriority",t,!1),".length"===n.key||".keys"===n.key)throw"setWithPriority failed: "+n.key+" is a read-only object.";const s=new c.BH;return Zn(n._repo,n._path,e,t,s.wrapCallback(()=>{})),s.promise}(this._delegate,e,t);return s&&i.then(()=>s(null),r=>s(r)),i}remove(e){(0,c.Dv)("Reference.remove",0,1,arguments.length),(0,c.Wj)("Reference.remove","onComplete",e,!0);const t=function Va(n){return V("remove",n._path),os(n,null)}(this._delegate);return e&&t.then(()=>e(null),s=>e(s)),t}transaction(e,t,s){(0,c.Dv)("Reference.transaction",1,3,arguments.length),(0,c.Wj)("Reference.transaction","transactionUpdate",e,!1),(0,c.Wj)("Reference.transaction","onComplete",t,!0),function(n,e,t,s){if(void 0!==t&&"boolean"!=typeof t)throw new Error((0,c.gK)("Reference.transaction","applyLocally")+"must be a boolean.")}(0,0,s);const i=function Rc(n,e,t){var s;if(n=(0,c.m9)(n),V("Reference.transaction",n._path),".length"===n.key||".keys"===n.key)throw"Reference.transaction failed: "+n.key+" is a read-only object.";const i=null===(s=null==t?void 0:t.applyLocally)||void 0===s||s,r=new c.BH,l=ls(n,()=>{});return function Da(n,e,t,s,i,r){Le(n,"transaction on "+e);const o={path:e,update:t,onComplete:s,status:null,order:gs(),applyLocally:r,retryCount:0,unwatcher:i,abortReason:null,currentWriteId:null,currentInputSnapshot:null,currentOutputSnapshotRaw:null,currentOutputSnapshotResolved:null},l=ts(n,e,void 0);o.currentInputSnapshot=l;const a=o.update(l.val());if(void 0===a)o.unwatcher(),o.currentOutputSnapshotRaw=null,o.currentOutputSnapshotResolved=null,o.onComplete&&o.onComplete(null,!1,o.currentInputSnapshot);else{lt("transaction failed: Data returned ",a,o.path),o.status=0;const h=Gt(n.transactionQueueTree_,e),u=Ee(h)||[];let d;u.push(o),zn(h,u),"object"==typeof a&&null!==a&&(0,c.r3)(a,".priority")?(d=(0,c.DV)(a,".priority"),(0,c.hu)(ot(d),"Invalid priority returned by transaction. Priority must be a valid string, finite number, server value, or null.")):d=(Bt(n.serverSyncTree_,e)||g.EMPTY_NODE).getPriority().val();const f=ht(n),_=R(a,d),p=Kn(_,l,f);o.currentOutputSnapshotRaw=_,o.currentOutputSnapshotResolved=p,o.currentWriteId=Yt(n);const C=Wn(n.serverSyncTree_,e,p,o.currentWriteId,o.applyLocally);W(n.eventQueue_,e,C),jt(n,n.transactionQueueTree_)}}(n._repo,n._path,e,(a,h,u)=>{let d=null;a?r.reject(a):(d=new Te(u,new G(n._repo,n._path),S),r.resolve(new Nc(h,d)))},l,i),r.promise}(this._delegate,e,{applyLocally:s}).then(r=>new Mc(r.committed,new ue(this.database,r.snapshot)));return t&&i.then(r=>t(null,r.committed,r.snapshot),r=>t(r,!1,null)),i}setPriority(e,t){(0,c.Dv)("Reference.setPriority",1,2,arguments.length),(0,c.Wj)("Reference.setPriority","onComplete",t,!0);const s=function Ga(n,e){n=(0,c.m9)(n),V("setPriority",n._path),Xn("setPriority",e,!1);const t=new c.BH;return Zn(n._repo,N(n._path,".priority"),e,null,t.wrapCallback(()=>{})),t.promise}(this._delegate,e);return t&&s.then(()=>t(null),i=>t(i)),s}push(e,t){(0,c.Dv)("Reference.push",0,2,arguments.length),(0,c.Wj)("Reference.push","onComplete",t,!0);const s=function Ba(n,e){n=(0,c.m9)(n),V("push",n._path),q("push",e,n._path,!0);const t=zi(n._repo),s=Ua(t),i=Ie(n,s),r=Ie(n,s);let o;return o=null!=e?os(r,e).then(()=>r):Promise.resolve(r),i.then=o.then.bind(o),i.catch=o.then.bind(o,void 0),i}(this._delegate,e),i=s.then(o=>new U(this.database,o));t&&i.then(()=>t(null),o=>t(o));const r=new U(this.database,s);return r.then=i.then.bind(i),r.catch=i.catch.bind(i,void 0),r}onDisconnect(){return V("Reference.onDisconnect",this._delegate._path),new Oc(new rr(this._delegate._repo,this._delegate._path))}get key(){return this.getKey()}get parent(){return this.getParent()}get root(){return this.getRoot()}}class ft{constructor(e,t){this._delegate=e,this.app=t,this.INTERNAL={delete:()=>this._delegate._delete(),forceWebSockets:yc,forceLongPolling:vc}}useEmulator(e,t,s={}){!function yr(n,e,t,s={}){(n=(0,c.m9)(n))._checkNotDeleted("useEmulator"),n._instanceStarted&&j("Cannot call useEmulator() after instance has already been initialized.");const i=n._repoInternal;let r;if(i.repoInfo_.nodeAdmin)s.mockUserToken&&j('mockUserToken is not supported by the Admin SDK. For client access with mock users, please use the "firebase" package instead of "firebase-admin".'),r=new Qe(Qe.OWNER);else if(s.mockUserToken){const o="string"==typeof s.mockUserToken?s.mockUserToken:(0,c.Sg)(s.mockUserToken,n.app.options.projectId);r=new Qe(o)}!function fc(n,e,t,s){n.repoInfo_=new on(`${e}:${t}`,!1,n.repoInfo_.namespace,n.repoInfo_.webSocketOnly,n.repoInfo_.nodeAdmin,n.repoInfo_.persistenceKey,n.repoInfo_.includeNamespaceInQueryParams,!0),s&&(n.authTokenProvider_=s)}(i,e,t,r)}(this._delegate,e,t,s)}ref(e){if((0,c.Dv)("database.ref",0,1,arguments.length),e instanceof U){const t=lr(this._delegate,e.toString());return new U(this,t)}{const t=or(this._delegate,e);return new U(this,t)}}refFromURL(e){(0,c.Dv)("database.refFromURL",1,1,arguments.length);const s=lr(this._delegate,e);return new U(this,s)}goOffline(){return(0,c.Dv)("database.goOffline",0,0,arguments.length),function Cc(n){(n=(0,c.m9)(n))._checkNotDeleted("goOffline"),Ji(n._repo)}(this._delegate)}goOnline(){return(0,c.Dv)("database.goOnline",0,0,arguments.length),function wc(n){(n=(0,c.m9)(n))._checkNotDeleted("goOnline"),function Aa(n){n.persistentConnection_&&n.persistentConnection_.resume(ji)}(n._repo)}(this._delegate)}}ft.ServerValue={TIMESTAMP:function Sc(){return Ic}(),increment:n=>function bc(n){return{".sv":{increment:n}}}(n)};var Fc=Object.freeze({__proto__:null,initStandalone:function Lc({app:n,url:e,version:t,customAuthImpl:s,namespace:i,nodeAdmin:r=!1}){_s(t);const o=new Ue.zt("auth-internal",new Ue.H0("database-standalone"));return o.setComponent(new Ue.wA("auth-internal",()=>s,"PRIVATE")),{instance:new ft(gr(n,o,void 0,e,r),n),namespace:i}}});const Wc=ft.ServerValue;!function Uc(n){n.INTERNAL.registerComponent(new Ue.wA("database-compat",(e,{instanceIdentifier:t})=>{const s=e.getProvider("app-compat").getImmediate(),i=e.getProvider("database").getImmediate({identifier:t});return new ft(i,s)},"PUBLIC").setServiceProps({Reference:U,Query:D,Database:ft,DataSnapshot:ue,enableLogging:Ec,INTERNAL:Fc,ServerValue:Wc}).setMultipleInstances(!0)),n.registerVersion("@firebase/database-compat","0.3.4")}(Hr.Z);var de=T(6796),Bc=T(8697);function Cr(n){return null==n}function wr(n){return"function"==typeof n.set}function Er(n,e){return wr(e)?e:n.ref(e)}function Tr(n,e){if(function Vc(n){return"string"==typeof n}(n))return e.stringCase();if(wr(n))return e.firebaseCase();if(function Gc(n){return"function"==typeof n.exportVal}(n))return e.snapshotCase();throw new Error("Expects a string, snapshot, or reference. Got: "+typeof n)}function _t(n,e,t="on",s=kr.z){return new Ar.y(i=>{let r=null;return r=n[t](e,(o,l)=>{s.schedule(()=>{i.next({snapshot:o,prevKey:l})}),"once"===t&&s.schedule(()=>i.complete())},o=>{s.schedule(()=>i.error(o))}),"on"===t?{unsubscribe(){null!=r&&n.off(e,r)}}:{unsubscribe(){}}}).pipe((0,Se.U)(i=>{const{snapshot:r,prevKey:o}=i;let l=null;return r.exists()&&(l=r.key),{type:e,payload:r,prevKey:o,key:l}}),(0,Or.B)())}function Ir(n,e){const t=n.length;for(let s=0;s<t;s++)if(n[s].payload.key===e)return s;return-1}function Kc(n,e){const{payload:t,prevKey:s,key:i}=e,r=Ir(n,i),o=function Qc(n,e){if(Cr(e))return 0;{const t=Ir(n,e);return-1===t?n.length:t+1}}(n,s);switch(e.type){case"value":if(e.payload&&e.payload.exists()){let l=null;e.payload.forEach(a=>{const h={payload:a,type:"value",prevKey:l,key:a.key};return l=a.key,n=[...n,h],!1})}return n;case"child_added":if(r>-1){const l=n[r-1];(l&&l.key||null)!==s&&(n=n.filter(a=>a.payload.key!==t.key)).splice(o,0,e)}else{if(null==s)return[e,...n];(n=n.slice()).splice(o,0,e)}return n;case"child_removed":return n.filter(l=>l.payload.key!==t.key);case"child_changed":return n.map(l=>l.payload.key===i?e:l);case"child_moved":if(r>-1){const l=n.splice(r,1)[0];return(n=n.slice()).splice(o,0,l),n}return n;default:return n}}function Sr(n){return(Cr(n)||0===n.length)&&(n=["child_added","child_removed","child_changed","child_moved"]),n}function br(n,e,t){return function Hc(n,e,t){return _t(n,"value","once",t).pipe((0,Mr.w)(s=>{const i=[(0,Dr.of)(s)];return e.forEach(r=>i.push(_t(n,r,"on",t))),(0,cs.T)(...i).pipe((0,hs.R)(Kc,[]))}),(0,Lr.x)())}(n,e=Sr(e),t)}function Nr(n,e,t){const s=(e=Sr(e)).map(i=>_t(n,i,"on",t));return(0,cs.T)(...s)}function Rr(n,e){return function(s,i){return Tr(s,{stringCase:()=>n.child(s)[e](i),firebaseCase:()=>s[e](i),snapshotCase:()=>s.ref[e](i)})}}function $c(n){return function(t){return t?Tr(t,{stringCase:()=>n.child(t).remove(),firebaseCase:()=>t.remove(),snapshotCase:()=>t.ref.remove()}):n.remove()}}function Pr(n,e){return function(){return _t(n,"value","on",e)}}T(7142);const Jc=new P.OlP("angularfire2.realtimeDatabaseURL"),Zc=new P.OlP("angularfire2.database.use-emulator");let eh=(()=>{class n{constructor(t,s,i,r,o,l,a,h,u,d,f,_,p,C,A){this.schedulers=l;const X=a,ee=(0,pt.on)(t,o,s);h&&(0,de.nw)(ee,o,u,f,_,p,d,C),this.database=(0,pt.cc)(`${ee.name}.database.${i}`,"AngularFireDatabase",ee.name,()=>{const We=o.runOutsideAngular(()=>ee.database(i||void 0));return X&&We.useEmulator(...X),We},[X])}list(t,s){const i=this.schedulers.ngZone.runOutsideAngular(()=>Er(this.database,t));let r=i;return s&&(r=s(i)),function qc(n,e){const t=e.schedulers.outsideAngular,s=e.schedulers.ngZone.run(()=>n.ref);return{query:n,update:Rr(s,"update"),set:Rr(s,"set"),push:i=>s.push(i),remove:$c(s),snapshotChanges:i=>br(n,i,t).pipe(fe.iC),stateChanges:i=>Nr(n,i,t).pipe(fe.iC),auditTrail:i=>function Yc(n,e,t){return function zc(n,e,t){return function jc(n,e){return _t(n,"value","on",e).pipe((0,Se.U)(t=>{let s;return t.payload.forEach(i=>(s=i.key,!1)),{data:t,lastKeyToLoad:s}}))}(n,t).pipe(function Vr(...n){const e=(0,Br.jO)(n);return(0,us.e)((t,s)=>{const i=n.length,r=new Array(i);let o=n.map(()=>!1),l=!1;for(let a=0;a<i;a++)(0,Fr.Xf)(n[a]).subscribe((0,Jt.x)(s,h=>{r[a]=h,!l&&!o[a]&&(o[a]=!0,(l=o.every(Wr.y))&&(o=null))},Ur.Z));t.subscribe((0,Jt.x)(s,a=>{if(l){const h=[a,...r];s.next(e?e(...h):h)}}))})}(e),(0,Se.U)(([i,r])=>{const o=i.lastKeyToLoad,l=r.map(a=>a.key);return{actions:r,lastKeyToLoad:o,loadedKeys:l}}),function Gr(n){return(0,us.e)((e,t)=>{let s=!1,i=0;e.subscribe((0,Jt.x)(t,r=>(s||(s=!n(r,i++)))&&t.next(r)))})}(i=>-1===i.loadedKeys.indexOf(i.lastKeyToLoad)),(0,Se.U)(i=>i.actions))}(n,Nr(n,e).pipe((0,hs.R)((i,r)=>[...i,r],[])),t)}(n,i,t).pipe(fe.iC),valueChanges:(i,r)=>br(n,i,t).pipe((0,Se.U)(l=>l.map(a=>r&&r.idField?Object.assign(Object.assign({},a.payload.val()),{[r.idField]:a.key}):a.payload.val())),fe.iC)}}(r,this)}object(t){return function Xc(n,e){return{query:n,snapshotChanges:()=>Pr(n,e.schedulers.outsideAngular)().pipe(fe.iC),update:t=>n.ref.update(t),set:t=>n.ref.set(t),remove:()=>n.ref.remove(),valueChanges:()=>Pr(n,e.schedulers.outsideAngular)().pipe(fe.iC,(0,Se.U)(s=>s.payload.exists()?s.payload.val():null))}}(this.schedulers.ngZone.runOutsideAngular(()=>Er(this.database,t)),this)}createPushId(){return this.schedulers.ngZone.runOutsideAngular(()=>this.database.ref()).push().key}}return n.\u0275fac=function(t){return new(t||n)(P.LFG(pt.Dh),P.LFG(pt.xv,8),P.LFG(Jc,8),P.LFG(P.Lbi),P.LFG(P.R0b),P.LFG(fe.HU),P.LFG(Zc,8),P.LFG(de.zQ,8),P.LFG(de.Qv,8),P.LFG(de.L6,8),P.LFG(de._Q,8),P.LFG(de.rT,8),P.LFG(de.lh,8),P.LFG(de.f7,8),P.LFG(Bc.nm,8))},n.\u0275prov=P.Yz7({token:n,factory:n.\u0275fac,providedIn:"any"}),n})()}}]);